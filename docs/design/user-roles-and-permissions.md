# 用户角色与权限定义

创建时间: 2025-01-04
版本: v0.2.0

---

## 用户角色分类

### 1. 路人 (Guest)
**定义**: 未注册或未登录的用户

**可用功能**:
- ✅ 浏览网站内容
- ✅ 下载游戏
- ✅ 浏览社区帖子

**不可用功能**:
- ❌ 发帖
- ❌ 评论
- ❌ 点赞
- ❌ 打赏
- ❌ 上传游戏
- ❌ 评分
- ❌ 购买推荐位

---

### 2. 管理员 (Admin)
**定义**: 由后台赋予管理权限的用户

**可用功能**:
- ✅ 浏览网站内容
- ✅ 下载游戏
- ✅ 浏览社区帖子
- ✅ 发帖
- ✅ 评论
- ✅ 点赞
- ✅ 发放社区新闻消息
- ✅ 封禁用户发言
- ✅ 删除不当言论
- ✅ 其他网站管理工作

**不可用功能**:
- ❌ 打赏
- ❌ 上传游戏

---

### 3. 玩家 (Player)
**定义**: 已登录但未参赛或未提交参赛作品的用户

**可用功能**:
- ✅ 浏览网站内容
- ✅ 下载游戏
- ✅ 浏览社区帖子
- ✅ 发帖
- ✅ 评论
- ✅ 点赞
- ✅ 打赏
- ✅ 上传游戏(非参赛作品)
- ✅ 购买推荐位(为他人的游戏)

**不可用功能**:
- ❌ 评分(仅参赛者和评审团可评分)

---

### 4. 参赛者 (Contestant)
**定义**: 已登录且参赛并提交了参赛作品的用户

**可用功能**:
- ✅ 浏览网站内容
- ✅ 下载游戏
- ✅ 浏览社区帖子
- ✅ 发帖
- ✅ 评论
- ✅ 点赞
- ✅ 打赏
- ✅ 评分(可以评价他人的游戏)
- ✅ 上传游戏

**不可用功能**:
- ❌ 购买推荐位(一般情况下,硬核个人参赛者除外)

**参赛者子分类**:

#### 4.1 团队参赛者 (Team Contestant)
- 团队规模: 2-9人
- 所有团队成员共享开发权限
- 团队成员不能评价自己团队的游戏

#### 4.2 个人参赛者 (Individual Contestant)
- 团队规模: 1人
- 独立完成开发与互动

##### 4.2.1 普通个人参赛者
- 不同意公开源码
- 不可购买推荐位

##### 4.2.2 硬核个人参赛者
- 同意公开源码
- ✅ 可以给自己的游戏买推荐位(额外奖励)
- 获得额外金币奖励

**评分限制**:
- ❌ 参赛者及其团队成员不能评价自己提交的游戏

---

### 5. 评审团 (Judge)
**定义**: 通过后台发放的邀请码注册的用户

**身份限制**:
- ❌ 评审团成员不能同时以参赛者身份参赛
- 原因: 既当选手又当裁判员不公平
- 选择成为评审团后,该账号无法提交参赛游戏

**可用功能**:
- ✅ 浏览网站内容
- ✅ 下载游戏
- ✅ 浏览社区帖子
- ✅ 发帖
- ✅ 评论
- ✅ 点赞
- ✅ 打赏
- ✅ 评分(可以评价参赛游戏)
- ✅ 购买推荐位

**不可用功能**:
- ❌ 上传游戏
- ❌ 提交参赛作品

---

## 角色关系图

```
未登录/未注册
    ↓
注册登录
    ↓
    ├─→ 管理员(后台赋予权限)
    │
    ├─→ 评审团(邀请码注册)
    │
    └─→ 普通用户
            ↓
        未提交参赛作品 → 玩家
            ↓
        提交参赛作品 → 参赛者
                      ├─→ 团队参赛者(2-9人)
                      └─→ 个人参赛者(1人)
                          ├─→ 普通个人参赛者(不公开源码)
                          └─→ 硬核个人参赛者(公开源码)
```

---

## 页面级权限控制

> **更新时间**: 2025-01-08
> **设计原则**: 基于角色的访问控制（Role-Based Access Control）
> **参考**: 角色定义详见 [关键名词解释索引_v1.1.md](./关键名词解释索引_v1.1.md#👤-用户角色系统)

---

### 设计原则

1. **稳定优于完美**: 第一届采用简单的基于角色的页面访问控制
2. **最小权限原则**: 每个角色只能访问其职责所需的页面和功能
3. **权限继承关系**: 参赛者 > 玩家 > 路人（权限逐级增加）
4. **特殊角色独立**: 评审团和管理员权限独立设计

---

### 核心页面权限矩阵

#### 1. 首页 (Homepage)

**可访问角色**: ✅ 所有人（路人、玩家、参赛者、评审团、管理员）

**各角色可见内容**:

| 角色 | 可见元素 | 可执行操作 |
|------|---------|-----------|
| 路人玩家 | 游戏列表、榜单、社区内容 | ✅ 浏览游戏<br>✅ 下载游戏<br>✅ 浏览社区帖子<br>❌ 登录/注册提示 |
| 玩家 | 所有内容 + 登录状态 | ✅ 所有路人功能<br>✅ 打赏游戏<br>❌ 评分按钮（隐藏）<br>❌ 上传游戏（参赛功能） |
| 参赛者 | 所有内容 + 参赛功能 | ✅ 所有玩家功能<br>✅ 评分入口<br>✅ 上传参赛作品<br>❌ 购买推荐位（一般情况） |
| 评审团 | 所有内容 + 评审功能 | ✅ 所有玩家功能<br>✅ 评分入口<br>✅ 购买推荐位<br>❌ 上传游戏（参赛功能，隐藏） |
| 管理员 | 所有内容 + 管理功能 | ✅ 浏览内容<br>✅ 管理入口<br>❌ 打赏<br>❌ 上传游戏 |

**UI控制规则**:
- 未登录: 显示"登录/注册"按钮，隐藏所有需要权限的操作
- 已登录但未参赛: 隐藏"评分"和"上传参赛作品"按钮
- 参赛者: 显示所有功能按钮
- 评审团: 显示"评分"按钮，隐藏"上传游戏"相关按钮

---

#### 2. 游戏详情页 (Game Detail Page)

**可访问角色**: ✅ 所有人

**各角色权限**:

| 功能 | 路人 | 玩家 | 参赛者 | 评审团 | 管理员 |
|------|------|------|--------|--------|--------|
| 浏览游戏信息 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 下载游戏 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 浏览评分 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 打赏游戏 | ❌ | ✅ | ✅ | ✅ | ❌ |
| 评分游戏 | ❌ | ❌ | ✅* | ✅ | ❌ |
| 购买推荐位 | ❌ | ✅** | ❌ | ✅ | ❌ |
| 编辑游戏 | ❌ | ❌ | ✅*** | ❌ | ❌ |

**限制条件**:
- \* 参赛者不能评价自己团队的游戏
- \*\* 玩家只能为他人的游戏购买推荐位
- \*\*\* 只能编辑自己上传的游戏

**UI控制规则**:
- 未登录: 显示"登录后可打赏/评分"提示
- 已登录但不是参赛者/评审团: 隐藏"评分"按钮，显示"仅参赛者和评审团可评分"
- 参赛者查看自己游戏: 隐藏"评分"按钮，显示"不能评价自己的游戏"
- 玩家购买推荐位: 显示"为他人游戏购买推荐位"选项，隐藏"为自己的游戏购买"

---

#### 3. 游戏评分页面 (Game Scoring Page)

**可访问角色**: ✅ 参赛者、评审团

**访问控制规则**:

```yaml
访问前检查:
  1. 检查用户是否登录
     - 未登录 → 跳转到登录页面，提示"请先登录"

  2. 检查用户角色
     - 角色 != 参赛者 且 角色 != 评审团 → 显示错误页面
       提示: "评分功能仅对参赛者和评审团开放"

  3. 检查是否评价过该游戏
     - 已评分过 → 显示"您已评分过该游戏，可修改评分"
     - 未评分 → 显示评分表单

  4. 检查是否是自己团队的游戏（参赛者）
     - 是自己团队的游戏 → 禁止访问
       提示: "不能评价自己团队的游戏"
```

**各角色权限**:

| 功能 | 参赛者 | 评审团 |
|------|--------|--------|
| 访问评分页面 | ✅ | ✅ |
| 评分6个维度 | ✅ | ✅ |
| 修改已有评分 | ✅ | ✅ |
| 打赏游戏 | ✅（必须） | ✅（必须） |
| 评价自己游戏 | ❌ | N/A（评审团无游戏） |

**UI控制规则**:
- 参赛者查看自己游戏: 显示"不能评价自己的游戏"，返回按钮
- 未完成打赏选择: 显示"请先选择打赏金额才能提交评分"

---

#### 4. 推荐位购买页面 (Recommendation Purchase Page)

**可访问角色**: ✅ 玩家、参赛者、评审团

**各角色权限**:

| 功能 | 路人 | 玩家 | 参赛者 | 评审团 | 管理员 |
|------|------|------|--------|--------|--------|
| 访问页面 | ❌ | ✅ | ✅* | ✅ | ❌ |
| 为他人购买 | ❌ | ✅ | ✅ | ✅ | ❌ |
| 为自己购买 | ❌ | ❌ | ❌ | ❌ | ❌ |

**限制条件**:
- \* 硬核个人参赛者可以为自己的游戏购买推荐位
- 玩家只能为他人的游戏购买推荐位
- 评审团可以为任何游戏购买推荐位

**访问控制规则**:
```yaml
访问前检查:
  1. 检查用户是否登录
     - 未登录 → 跳转到登录页面

  2. 检查用户角色
     - 角色 == 路人 或 角色 == 管理员 → 显示错误页面
       提示: "推荐位购买功能仅对玩家、参赛者、评审团开放"

  3. 检查金币余额
     - 金币不足 → 显示"金币不足，无法购买"
```

---

#### 5. 个人中心 (Personal Center)

**可访问角色**: ✅ 玩家、参赛者、评审团

**各角色可见功能**:

| 功能 | 路人 | 玩家 | 参赛者 | 评审团 | 管理员 |
|------|------|------|--------|--------|--------|
| 访问个人中心 | ❌ | ✅ | ✅ | ✅ | ✅ |
| 查看个人信息 | ❌ | ✅ | ✅ | ✅ | ✅ |
| 修改个人信息 | ❌ | ✅ | ✅ | ✅ | ✅ |
| 查看金币余额 | ❌ | ✅ | ✅ | ✅ | ❌ |
| 查看评分记录 | ❌ | ❌ | ✅ | ✅ | ❌ |
| 查看团队信息 | ❌ | ❌ | ✅ | ❌ | ❌ |
| 管理团队 | ❌ | ❌ | ✅ | ❌ | ❌ |

**UI控制规则**:
- 未登录: 跳转到登录页面
- 玩家: 显示基础信息 + 金币，隐藏"评分记录"和"团队信息"
- 参赛者: 显示所有功能
- 评审团: 显示评分记录，隐藏"团队信息"

---

#### 6. 团队管理页面 (Team Management Page)

**可访问角色**: ✅ 参赛者（团队成员）

**访问控制规则**:

```yaml
访问前检查:
  1. 检查用户是否登录
     - 未登录 → 跳转到登录页面

  2. 检查用户角色
     - 角色 != 参赛者 → 显示错误页面
       提示: "团队管理功能仅对参赛者开放"

  3. 检查是否属于团队
     - 不属于团队 → 显示"您尚未加入团队"
     - 属于团队 → 显示团队信息

  4. 检查团队角色权限
     - 队长: 所有管理权限
     - 副队长: 部分管理权限（邀请成员、修改信息）
     - 成员: 仅查看权限
```

**各角色权限**:

| 功能 | 队长 | 副队长 | 成员 |
|------|------|--------|------|
| 查看团队信息 | ✅ | ✅ | ✅ |
| 邀请成员 | ✅ | ✅ | ❌ |
| 移除成员 | ✅ | ❌ | ❌ |
| 修改团队信息 | ✅ | ✅ | ❌ |
| 提交作品 | ✅ | ✅ | ❌ |
| 解散团队 | ✅ | ❌ | ❌ |
| 退出团队 | ❌ | ❌ | ✅ |

---

#### 7. 后台管理页面 (Admin Panel)

**可访问角色**: ✅ 管理员

**访问控制规则**:

```yaml
访问前检查:
  1. 检查用户是否登录
     - 未登录 → 跳转到登录页面

  2. 检查用户角色
     - 角色 != 管理员 → 显示403错误页面
       提示: "您没有权限访问管理后台"

  3. 检查管理员权限级别
     - 根据权限级别显示不同管理模块
```

**各角色权限**:

| 功能 | 路人 | 玩家 | 参赛者 | 评审团 | 管理员 |
|------|------|------|--------|--------|--------|
| 访问后台 | ❌ | ❌ | ❌ | ❌ | ✅ |
| 发放社区新闻 | ❌ | ❌ | ❌ | ❌ | ✅ |
| 封禁用户发言 | ❌ | ❌ | ❌ | ❌ | ✅ |
| 删除不当言论 | ❌ | ❌ | ❌ | ❌ | ✅ |
| 用户管理 | ❌ | ❌ | ❌ | ❌ | ✅ |
| 系统配置 | ❌ | ❌ | ❌ | ❌ | ✅ |

---

#### 8. 社区页面 (Community Page)

**可访问角色**: ✅ 所有人

**各角色权限**:

| 功能 | 路人 | 玩家 | 参赛者 | 评审团 | 管理员 |
|------|------|------|--------|--------|--------|
| 浏览帖子 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 发帖 | ❌ | ✅ | ✅ | ✅ | ✅ |
| 评论 | ❌ | ✅ | ✅ | ✅ | ✅ |
| 点赞 | ❌ | ✅ | ✅ | ✅ | ✅ |
| 打赏帖主 | ❌ | ✅ | ✅ | ✅ | ❌ |
| 删除帖子 | ❌ | ❌ | 自己的 | 自己的 | ✅ |

**UI控制规则**:
- 未登录: 显示"登录后可发帖/评论/点赞"
- 已登录: 显示所有互动按钮
- 管理员: 显示"删除"按钮（所有帖子）

---

### 实现建议

#### 前端实现

```typescript
// 权限检查工具函数
function canAccessPage(userRole: UserRole, page: PageType): boolean {
  const accessMatrix = {
    'homepage': ['guest', 'player', 'contestant', 'judge', 'admin'],
    'game-detail': ['guest', 'player', 'contestant', 'judge', 'admin'],
    'game-scoring': ['contestant', 'judge'],
    'recommendation-purchase': ['player', 'contestant', 'judge'],
    'personal-center': ['player', 'contestant', 'judge', 'admin'],
    'team-management': ['contestant'],
    'admin-panel': ['admin'],
    'community': ['guest', 'player', 'contestant', 'judge', 'admin'],
  };

  return accessMatrix[page].includes(userRole);
}

// 功能权限检查
function canPerformAction(
  userRole: UserRole,
  action: ActionType,
  context?: any
): boolean {
  // 实现具体的功能权限检查逻辑
  // 例如: 参赛者不能评价自己团队的游戏
  if (action === 'score-game' && userRole === 'contestant') {
    return !isOwnTeamGame(context.gameId, context.userId);
  }

  // 更多规则...
}
```

#### 后端实现

```typescript
// 中间件: 页面访问控制
app.get('/game/:id/scoring', (req, res) => {
  const user = req.user;

  // 检查登录
  if (!user) {
    return res.redirect('/login');
  }

  // 检查角色
  if (!['contestant', 'judge'].includes(user.role)) {
    return res.status(403).render('error', {
      message: '评分功能仅对参赛者和评审团开放'
    });
  }

  // 检查是否是自己团队的游戏
  if (user.role === 'contestant' && isOwnTeamGame(req.params.id, user.id)) {
    return res.status(403).render('error', {
      message: '不能评价自己团队的游戏'
    });
  }

  // 通过检查，渲染页面
  res.render('game-scoring', { game, user });
});
```

---

### 测试用例

#### 测试场景1: 参赛者尝试访问评分页面

```yaml
前置条件: 用户A已登录，角色为参赛者，提交了游戏X

测试步骤:
  1. 用户A访问游戏X的评分页面
  2. 系统检测到游戏X是用户A自己提交的游戏

预期结果:
  - 显示错误页面
  - 提示"不能评价自己团队的游戏"
  - 提供"返回"按钮

实际结果: [待测试]
```

#### 测试场景2: 玩家尝试访问评分页面

```yaml
前置条件: 用户B已登录，角色为玩家（未参赛）

测试步骤:
  1. 用户B尝试访问游戏Y的评分页面

预期结果:
  - 显示错误页面
  - 提示"评分功能仅对参赛者和评审团开放"
  - 提供"返回首页"按钮

实际结果: [待测试]
```

---

### 相关决策

- **决策9**: 团队作品排名规则（个人作品 vs 团队作品）
- **问题4.6**: 页面级权限控制设计（本文档）
- **关键名词解释索引_v1.1.md**: 用户角色系统定义

---

### 待补充内容

以下内容需要在后续版本中补充:

- [ ] 更详细的UI元素显示规则
- [ ] API接口级权限控制
- [ ] 数据级权限控制（例如：只能看到自己的数据）
- [ ] 权限变更流程（例如：参赛 → 评审团的转化）
- [ ] 临时权限机制（例如：临时管理员）

---

---

## 变更历史

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|---------|------|
| 2025-01-08 | v0.2.0 | 新增完整的页面级权限控制章节（8个核心页面权限矩阵+实现建议+测试用例） | Claude |
| 2025-01-04 | v0.1.0 | 初始版本,定义5种用户角色及基础权限 | Claude |
