---
description: 完成任务后的自检,检查文档是否完整同步
argument-hint: [任务名称]
allowed-tools: Read, Grep
---

# 完成自检器

完成任务后自动检查所有相关文档是否已更新,避免遗漏。

## 核心功能

1. **问题清单检查**
   - 检查问题是否已标记✅
   - 检查是否有用户回答
   - 检查是否有决策记录

2. **设计文档检查**
   - 检查相关章节是否已更新
   - 检查内容是否与问题清单一致
   - 检查决策日期是否记录

3. **CHANGELOG检查**
   - 检查是否有版本更新记录
   - 检查变更描述是否完整
   - 检查日期是否正确

4. **开发日志检查**
   - 检查是否创建了日志条目
   - 检查任务完成记录是否完整

5. **交叉引用检查**
   - 检查是否有失效的链接
   - 检查版本号是否一致

## 使用方法

```bash
/check-completion                    # 检查最近的修改
/check-completion "Q1.2讨论完成"      # 检查指定任务
```

## 执行流程

### 步骤1: 确定检查范围

```bash
如果用户提供了任务名称 $1:
  使用 $1 作为任务上下文
否则:
  读取最近的修改记录
  推断刚完成的任务
```

### 步骤2: 扫描问题清单

```bash
查找: development/issues/*questions.md

检查项:
- 最近标记✅的问题
- 问题的完整性(有选项、有回答、有决策)
- 记录格式是否正确
```

### 步骤3: 检查设计文档

```bash
对每个已确认的问题:
1. 从问题清单提取涉及的文档和章节
2. 读取对应设计文档
3. 检查章节内容是否已更新
4. 对比决策是否一致
```

### 步骤4: 检查CHANGELOG

```bash
读取: docs/product/CHANGELOG.md

检查项:
- 顶部版本是否是最新
- 是否有今日的变更记录
- 变更描述是否清晰
```

### 步骤5: 检查开发日志

```bash
查找: development/logs/dev-log-{今日日期}.md

检查项:
- 文件是否存在
- 是否有今日的任务记录
- 记录是否详细
```

### 步骤6: 生成自检报告

```markdown
✅ **完成自检报告**

━━━━━━━━━━━━━━━━

📋 **任务**: {任务名称或自动推断}
📅 **检查时间**: 2025-01-06 20:30

━━━━━━━━━━━━━━━━

✅ **问题清单检查** (通过)
- ✅ Q1.2已标记完成
- ✅ 包含用户选择: A
- ✅ 包含用户理由
- ✅ 包含最终决策
- ✅ 包含决策日期

━━━━━━━━━━━━━━━━

✅ **设计文档检查** (通过)
- ✅ 评分系统设计方案_v1.0.md §2.2已更新
- ✅ 内容与问题清单一致
- ✅ 已记录决策日期: 2025-01-06
- ✅ 包含完整的决策说明

━━━━━━━━━━━━━━━━

✅ **CHANGELOG检查** (通过)
- ✅ v1.4已记录相关变更
- ✅ 变更描述清晰
- ✅ 日期正确

━━━━━━━━━━━━━━━━

⚠️ **开发日志检查** (需要关注)
- ✅ 文件存在: dev-log-2025-01-06.md
- ⚠️ 缺少Q1.2的完成记录
- 💡 建议: 添加任务完成记录

━━━━━━━━━━━━━━━━

✅ **交叉引用检查** (通过)
- ✅ 未发现失效链接
- ✅ 版本号一致(v1.4)

━━━━━━━━━━━━━━━━

📊 **自检结果**:

✅ 通过: 4项
⚠️ 需要关注: 1项
❌ 失败: 0项

━━━━━━━━━━━━━━━━

💡 **建议操作**:

1. 补充开发日志记录:
   ```
   ### Q1.2完成 - 2025-01-06 20:00

   **任务**: 确定评分颗粒度设计

   **决策**: 选择A - 支持0.5分档位

   **完成情况**:
   - ✅ 问题清单已更新
   - ✅ 设计文档已同步
   - ✅ CHANGELOG已记录
   ```

2. 或运行 /sync-docs 自动创建日志

━━━━━━━━━━━━━━━━

🎯 **总体评价**: 良好

所有关键文档已同步,仅需补充开发日志记录。
任务完成质量: 高

━━━━━━━━━━━━━━━━
```

## 错误处理

### 情况1: 找不到问题清单

```markdown
⚠️ 未找到问题清单

检查目录: development/issues/

结果: 没有找到 *questions.md 文件

可能原因:
1. 还没有创建问题清单
2. 任务类型不涉及问题讨论

建议:
- 如果是问题讨论任务,先创建问题清单
- 如果是其他类型任务,仅检查相关文档
```

### 情况2: 设计文档未更新

```markdown
❌ **设计文档检查失败**

━━━━━━━━━━━━━━━━

问题: Q1.2已确认但设计文档未更新

问题清单显示:
- Q1.2已确认,选择A
- 决策: 支持0.5分档位

设计文档状态:
- 评分系统设计方案_v1.0.md §2.2
- 内容: 未更新,还是旧版本

━━━━━━━━━━━━━━━━

💡 **建议操作**:

1. 立即执行: /sync-docs 同步文档
2. 或手动更新设计文档§2.2
3. 更新后重新运行自检
```

### 情况3: CHANGELOG未更新

```markdown
⚠️ **CHANGELOG未更新**

━━━━━━━━━━━━━━━━

检测到:
- Q1.2已确认完成
- 设计文档已更新

但CHANGELOG最新版本(v1.4)中没有记录此变更

━━━━━━━━━━━━━━━━

💡 **建议操作**:

在CHANGELOG.md顶部添加:
```markdown
## v1.5 (2025-01-06)

### 变更
- ✅ 确认Q1.2评分颗粒度设计
  - 决策: 支持0.5分档位
  - 更新: 评分系统设计方案_v1.0.md §2.2
```

或运行: /sync-docs 自动更新
```

## 快速模式

如果用户只是快速确认,输出简化版:

```markdown
🔍 快速自检

━━━━━━━━━━━━━━━━

检查: {任务名称}

✅ 问题清单: 已更新
✅ 设计文档: 已同步
✅ CHANGELOG: 已记录
⚠️ 开发日志: 待补充

━━━━━━━━━━━━━━━━

结果: 基本通过,建议补充日志

运行 /sync-docs 自动补充
```

## 使用建议

1. **问题讨论后**: 确认每个问题后运行自检
2. **任务完成后**: 整体任务完成后运行自检
3. **提交前**: 提交代码前运行自检
4. **定期检查**: 每天结束时运行一次全面检查

## 开发信息

- **创建时间**: 2025-01-06
- **开发者**: 老黑(Claude)
- **版本**: 1.0
- **状态**: 开发中
- **预计完成**: 2025-01-06
- **部署位置**: `.claude/commands/check-completion.md`

---
