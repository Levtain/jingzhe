# æƒŠè›°è®¡åˆ’ - è¯„åˆ†ç³»ç»Ÿç³»ç»Ÿæ¶æ„æ–‡æ¡£

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-01-10
**æœ€åæ›´æ–°**: 2025-01-10
**æ–‡æ¡£çŠ¶æ€**: ğŸ”„ åˆç¨¿
**ç›¸å…³æ–‡æ¡£**:
- [è¯„åˆ†ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ v2.5](../design/è¯„åˆ†ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ_v1.0.md)
- [æ’åç³»ç»ŸæŠ€æœ¯å®ç°æ–‡æ¡£ v1.0](../design/archive/ranking_system_v1_deprecated/æ’åç³»ç»ŸæŠ€æœ¯å®ç°æ–‡æ¡£_v1.0.md)

---

## æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£å®šä¹‰æƒŠè›°è®¡åˆ’è¯„åˆ†ç³»ç»Ÿçš„ç³»ç»Ÿæ¶æ„,åŒ…æ‹¬æ•°æ®æµæ°´çº¿ã€è®¡ç®—æµç¨‹ã€ç¼“å­˜ç­–ç•¥ã€ç›‘æ§æŒ‡æ ‡ã€å›æ»šæµç¨‹ç­‰å·¥ç¨‹å®ç°ç»†èŠ‚ã€‚

**é€‚ç”¨èŒƒå›´**: ç¬¬ä¸€å±Šè¯„åˆ†ç³»ç»Ÿ(æˆªå°¾å‡å€¼ + è´å¶æ–¯å¹³æ»‘ + å•ç»´åº¦æ’å)

---

## ä¸€ã€ç³»ç»Ÿæ¶æ„æ€»è§ˆ

### 1.1 æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯å±‚                                 â”‚
â”‚  - è¯„åˆ†é¡µé¢(æ»‘å—äº¤äº’)                                          â”‚
â”‚  - æ¦œå•å±•ç¤ºé¡µé¢(Tabåˆ‡æ¢)                                       â”‚
â”‚  - æ¸¸æˆè¯¦æƒ…é¡µ(è¯„åˆ†ç»Ÿè®¡)                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTP/REST API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      APIç½‘å…³å±‚                                â”‚
â”‚  - é€Ÿç‡é™åˆ¶(10åˆ†é’Ÿå†…â‰¤6ä¸ªè¯„åˆ†)                                  â”‚
â”‚  - æƒé™éªŒè¯(å‚èµ›è€…/è¯„å®¡å›¢)                                     â”‚
â”‚  - é˜¶æ®µçŠ¶æ€æ£€æŸ¥(è¯„åˆ†é˜¶æ®µæ˜¯å¦å¼€æ”¾)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸šåŠ¡é€»è¾‘å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ è¯„åˆ†æœåŠ¡     â”‚  â”‚ æ’åæœåŠ¡     â”‚  â”‚ åä½œå¼ŠæœåŠ¡   â”‚       â”‚
â”‚  â”‚ - æäº¤è¯„åˆ†   â”‚  â”‚ - è®¡ç®—æ’å   â”‚  â”‚ - ç›‘æµ‹å¼‚å¸¸   â”‚       â”‚
â”‚  â”‚ - ä¿®æ”¹è¯„åˆ†   â”‚  â”‚ - ç¼“å­˜ç®¡ç†   â”‚  â”‚ - æ ‡è®°å¯ç–‘   â”‚       â”‚
â”‚  â”‚ - æŸ¥è¯¢è¯„åˆ†   â”‚  â”‚ - é‡ç®—è§¦å‘   â”‚  â”‚ - å¤æ ¸æµç¨‹   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®è®¿é—®å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ PostgreSQL   â”‚  â”‚    Redis     â”‚  â”‚  æ¶ˆæ¯é˜Ÿåˆ—    â”‚       â”‚
â”‚  â”‚ - è¯„åˆ†æ•°æ®   â”‚  â”‚ - ç¼“å­˜æ’å   â”‚  â”‚ - å¼‚æ­¥é‡ç®—   â”‚       â”‚
â”‚  â”‚ - æ¸¸æˆæ•°æ®   â”‚  â”‚ - TTL 5åˆ†é’Ÿ  â”‚  â”‚ - é€šçŸ¥å‘é€   â”‚       â”‚
â”‚  â”‚ - ç”¨æˆ·æ•°æ®   â”‚  â”‚              â”‚  â”‚              â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ•°æ®æµæ€»è§ˆ

```
è¯„åˆ†æäº¤
   â†“
[APIç½‘å…³] æƒé™éªŒè¯ + é€Ÿç‡é™åˆ¶
   â†“
[è¯„åˆ†æœåŠ¡] æ•°æ®éªŒè¯ + å­˜å‚¨åˆ°PostgreSQL
   â†“
[æ¶ˆæ¯é˜Ÿåˆ—] è§¦å‘å¼‚æ­¥é‡ç®—ä»»åŠ¡
   â†“
[æ’åæœåŠ¡] è®¡ç®—æ’å â†’ Redisç¼“å­˜
   â†“
[å‰ç«¯è½®è¯¢/WebSocket] è·å–æœ€æ–°æ’å
```

---

## äºŒã€æ•°æ®æµæ°´çº¿è®¾è®¡

### 2.1 æ•°æ®æ¨¡å‹

#### æ ¸å¿ƒè¡¨ç»“æ„

```sql
-- åŸå§‹è¯„åˆ†è¡¨
CREATE TABLE ratings (
    id BIGSERIAL PRIMARY KEY,
    game_id BIGINT NOT NULL,                    -- æ¸¸æˆID
    rater_id BIGINT NOT NULL,                   -- è¯„åˆ†è€…ID
    rater_type VARCHAR(20) NOT NULL,            -- è¯„åˆ†è€…ç±»å‹: 'participant' | 'judge'

    -- 6ä¸ªç»´åº¦è¯„åˆ†
    innovation_score DECIMAL(4,2),              -- åˆ›æ–°æ€§
    theme_score DECIMAL(4,2),                   -- ä¸»é¢˜è¯ é‡Š
    visual_score DECIMAL(4,2),                  -- è§†è§‰æ•ˆæœ
    audio_score DECIMAL(4,2),                   -- éŸ³ä¹éŸ³é¢‘
    completeness_score DECIMAL(4,2),            -- æ•´ä½“æ€§
    fun_factor_score DECIMAL(4,2),              -- æ•´æ´»å„¿

    -- çŠ¶æ€æ ‡è®°
    is_valid BOOLEAN DEFAULT true,              -- æ˜¯å¦æœ‰æ•ˆ
    is_suspicious BOOLEAN DEFAULT false,        -- æ˜¯å¦å¯ç–‘
    suspicious_reason TEXT,                     -- å¯ç–‘åŸå› 

    -- å®¡è®¡å­—æ®µ
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    -- å”¯ä¸€çº¦æŸ: æ¯ä¸ªè¯„åˆ†è€…å¯¹æ¯ä¸ªæ¸¸æˆåªèƒ½æœ‰ä¸€æ¡æœ‰æ•ˆè¯„åˆ†
    UNIQUE (game_id, rater_id)
);

-- æ¸¸æˆç»´åº¦å¾—åˆ†è¡¨(è®¡ç®—ç»“æœ)
CREATE TABLE game_dimension_scores (
    id BIGSERIAL PRIMARY KEY,
    game_id BIGINT NOT NULL,
    dimension VARCHAR(20) NOT NULL,             -- ç»´åº¦åç§°: 'innovation' | 'theme' | ...

    -- åŸå§‹ç»Ÿè®¡
    raw_mean DECIMAL(5,3),                      -- åŸå§‹å¹³å‡åˆ†
    raw_count INTEGER,                          -- åŸå§‹è¯„åˆ†æ•°é‡

    -- æˆªå°¾å‡å€¼ç»“æœ
    trimmed_mean DECIMAL(5,3),                  -- æˆªå°¾å‡å€¼
    trimmed_count INTEGER,                      -- æˆªå°¾åæ•°é‡
    variance DECIMAL(8,6),                      -- æ–¹å·®

    -- è´å¶æ–¯å¹³æ»‘ç»“æœ
    bayesian_score DECIMAL(5,3),               -- è´å¶æ–¯å¹³æ»‘åˆ†æ•°
    global_mean DECIMAL(5,3),                   -- å…¨å±€å‡å€¼

    -- è¯„å®¡å›¢ç»Ÿè®¡
    judge_count INTEGER,                        -- è¯„å®¡å›¢äººæ•°
    judge_avg_score DECIMAL(5,3),               -- è¯„å®¡å›¢å¹³å‡åˆ†

    -- æ’åä¿¡æ¯
    participant_rank INTEGER,                   -- å‚èµ›è€…æ¦œæ’å
    judge_rank INTEGER,                         -- è¯„å®¡å›¢æ¦œæ’å

    -- é—¨æ§›åˆ¤å®š
    total_rating_count INTEGER,                 -- æ€»è¯„åˆ†äººæ¬¡(è¯„å®¡å›¢Ã—2)
    is_ranked BOOLEAN,                          -- æ˜¯å¦è¿›å…¥æ’å

    -- ç¼“å­˜æ§åˆ¶
    last_calculated_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),

    UNIQUE (game_id, dimension)
);

-- æ’åæ¦œå•è¡¨(12ä¸ªæ¦œå•)
CREATE TABLE rankings (
    id BIGSERIAL PRIMARY KEY,
    dimension VARCHAR(20) NOT NULL,             -- ç»´åº¦
    group_type VARCHAR(20) NOT NULL,            -- ç¾¤ä½“: 'participant' | 'judge'
    season_id VARCHAR(50) NOT NULL,             -- èµ›å­£ID

    -- æ’åæ•°æ®(JSONå­˜å‚¨,ä¾¿äºæ‰¹é‡æŸ¥è¯¢)
    ranking_data JSONB NOT NULL,                -- æ ¼å¼: [{rank, game_id, score, ...}]

    -- å…ƒæ•°æ®
    total_games INTEGER,                        -- æ€»æ¸¸æˆæ•°
    ranked_games INTEGER,                       -- è¿›å…¥æ’åçš„æ¸¸æˆæ•°
    last_game_score DECIMAL(5,3),              -- æœ€åä¸€åå¾—åˆ†

    -- ç‰ˆæœ¬æ§åˆ¶
    version INTEGER,                            -- æ¦œå•ç‰ˆæœ¬(æ¯æ¬¡é‡ç®—+1)
    created_at TIMESTAMP DEFAULT NOW(),

    UNIQUE (dimension, group_type, season_id)
);

-- åä½œå¼Šå®¡è®¡è¡¨
CREATE TABLE anti_cheat_logs (
    id BIGSERIAL PRIMARY KEY,
    rating_id BIGINT REFERENCES ratings(id),

    -- æ£€æµ‹ç±»å‹
    detection_type VARCHAR(50),                 -- 'high_frequency' | 'low_scores' | 'manual_report'
    detection_details JSONB,                    -- æ£€æµ‹è¯¦æƒ…

    -- å¤„ç†çŠ¶æ€
    status VARCHAR(20),                         -- 'pending' | 'confirmed' | 'rejected'
    handled_by BIGINT,                          -- å¤„ç†äººID
    handled_at TIMESTAMP,

    -- å®¡è®¡
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### ç´¢å¼•è®¾è®¡

```sql
-- è¯„åˆ†è¡¨ç´¢å¼•
CREATE INDEX idx_ratings_game_id ON ratings(game_id);
CREATE INDEX idx_ratings_rater_id ON ratings(rater_id);
CREATE INDEX idx_ratings_is_valid ON ratings(is_valid) WHERE is_valid = false;
CREATE INDEX idx_ratings_is_suspicious ON ratings(is_suspicious) WHERE is_suspicious = true;
CREATE INDEX idx_ratings_created_at ON ratings(created_at DESC);

-- æ¸¸æˆå¾—åˆ†è¡¨ç´¢å¼•
CREATE INDEX idx_game_scores_game_id ON game_dimension_scores(game_id);
CREATE INDEX idx_game_scores_is_ranked ON game_dimension_scores(is_ranked) WHERE is_ranked = true;
CREATE INDEX idx_game_scores_participant_rank ON game_dimension_scores(dimension, participant_rank);
CREATE INDEX idx_game_scores_judge_rank ON game_dimension_scores(dimension, judge_rank);

-- æ¦œå•è¡¨ç´¢å¼•
CREATE INDEX idx_rankings_dimension_group ON rankings(dimension, group_type, season_id);
CREATE INDEX idx_rankings_created_at ON rankings(created_at DESC);

-- åä½œå¼Šè¡¨ç´¢å¼•
CREATE INDEX idx_anti_cheat_status ON anti_cheat_logs(status) WHERE status = 'pending';
CREATE INDEX idx_anti_cheat_created_at ON anti_cheat_logs(created_at DESC);
```

### 2.2 ETLæµç¨‹

#### æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åŸå§‹æ•°æ®é‡‡é›†(ratings_raw)                                 â”‚
â”‚    - è¯„åˆ†æ•°å€¼                                                â”‚
â”‚    - è¯„åˆ†è€…ä¿¡æ¯                                              â”‚
â”‚    - æ—¶é—´æˆ³ã€IPç­‰å…ƒæ•°æ®                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æ•°æ®æ¸…æ´—ä¸éªŒè¯                                            â”‚
â”‚    - æ’é™¤è‡ªè¯„(game.author_id = rater_id)                    â”‚
â”‚    - æ£€æŸ¥è¯„åˆ†èŒƒå›´(0-10, step 0.5)                           â”‚
â”‚    - æ ‡è®°å¯ç–‘è¯„åˆ†(is_suspiciousæ ‡è®°)                         â”‚
â”‚    - è¿‡æ»¤is_valid=falseçš„è¯„åˆ†                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æˆªå°¾å‡å€¼è®¡ç®—(Winsorized Mean)                             â”‚
â”‚    - æŒ‰game_id + dimensionåˆ†ç»„                              â”‚
â”‚    - æ’åºå¹¶ç§»é™¤ä¸Šä¸‹å„10%                                     â”‚
â”‚    - è®¡ç®—å‰©ä½™è¯„åˆ†çš„ç®—æœ¯å¹³å‡                                  â”‚
â”‚    - å°æ ·æœ¬(<10ä¸ª)ä¸æˆªæ–­                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å…¨å±€å‡å€¼è®¡ç®—                                              â”‚
â”‚    - ä»…åŒ…å«é€šè¿‡é—¨æ§›çš„æ¸¸æˆ(>15äººæ¬¡)                           â”‚
â”‚    - æŒ‰dimensionåˆ†ç»„è®¡ç®—                                     â”‚
â”‚    - global_mean = Î£(trimmed_mean) / count                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. è´å¶æ–¯å¹³æ»‘è®¡ç®—                                            â”‚
â”‚    - å…¬å¼: S' = (nÃ—S + 20Ã—Î¼) / (n+20)                        â”‚
â”‚    - n: è¯„åˆ†äººæ¬¡(è¯„å®¡å›¢Ã—2)                                   â”‚
â”‚    - S: æˆªå°¾å‡å€¼                                             â”‚
â”‚    - Î¼: å…¨å±€å‡å€¼                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. æ’åè®¡ç®—                                                  â”‚
â”‚    - æŒ‰dimension + group_typeåˆ†ç»„                           â”‚
â”‚    - æŒ‰bayesian_scoreé™åºæ’åº                                â”‚
â”‚    - å¤„ç†å¹¶åˆ—(ä¸‰çº§tie-breaker)                               â”‚
â”‚    - åˆ¤å®šä¼˜é€‰æ¸¸æˆ(3+ä¸ªç»´åº¦å‰10)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. æ¦œå•ç”Ÿæˆ(12ä¸ªæ¦œå•)                                        â”‚
â”‚    - å‚èµ›è€…æ¦œ(6ä¸ªç»´åº¦)                                       â”‚
â”‚    - è¯„å®¡å›¢æ¦œ(6ä¸ªç»´åº¦)                                       â”‚
â”‚    - ä¼˜é€‰æ¸¸æˆæ¦œ(2ä¸ªç¾¤ä½“)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è®¡ç®—ä¼ªä»£ç 

```python
def recalculate_rankings(season_id: str):
    """
    å…¨é‡é‡ç®—æ’å
    """
    # æ­¥éª¤1: è·å–æ‰€æœ‰æ¸¸æˆ
    games = get_all_games(season_id)

    # æ­¥éª¤2: å¯¹æ¯ä¸ªç»´åº¦åˆ†åˆ«è®¡ç®—
    for dimension in ['innovation', 'theme', 'visual', 'audio', 'completeness', 'fun_factor']:
        # 2.1 è®¡ç®—å…¨å±€å‡å€¼(ä»…åŒ…å«é€šè¿‡é—¨æ§›çš„æ¸¸æˆ)
        global_mean = calculate_global_mean(games, dimension, threshold=15)

        # 2.2 è®¡ç®—æ¯ä¸ªæ¸¸æˆçš„å¾—åˆ†
        game_scores = []
        for game in games:
            # 2.2.1 è·å–æœ‰æ•ˆè¯„åˆ†(æ’é™¤è‡ªè¯„ã€å¯ç–‘è¯„åˆ†)
            valid_ratings = get_valid_ratings(game.id, dimension)

            # 2.2.2 è®¡ç®—è¯„åˆ†äººæ¬¡(è¯„å®¡å›¢Ã—2)
            total_count = calculate_total_count(valid_ratings)

            # 2.2.3 æ£€æŸ¥æ’åèµ„æ ¼
            if total_count <= 15:
                # æœªè¾¾é—¨æ§›,ä¸å‚ä¸æ’å
                save_unranked_game(game.id, dimension, valid_ratings)
                continue

            # 2.2.4 è®¡ç®—æˆªå°¾å‡å€¼
            trimmed_mean, variance = calculate_trimmed_mean(valid_ratings)

            # 2.2.5 è´å¶æ–¯å¹³æ»‘
            bayesian_score = apply_bayesian_smoothing(
                trimmed_mean, total_count, global_mean, k=20
            )

            # 2.2.6 ä¿å­˜å¾—åˆ†
            game_scores.append({
                'game_id': game.id,
                'score': round(bayesian_score, 3),  # ä¿ç•™3ä½å°æ•°
                'count': total_count,
                'variance': variance,
                'judge_ratio': calculate_judge_ratio(valid_ratings)
            })

        # æ­¥éª¤3: æ’åºå¹¶å¤„ç†å¹¶åˆ—
        ranked_games = sort_and_break_ties(game_scores)

        # æ­¥éª¤4: ä¿å­˜æ¦œå•
        save_ranking(dimension, 'participant', ranked_games, season_id)
        save_ranking(dimension, 'judge', ranked_games, season_id)

    # æ­¥éª¤5: è®¡ç®—ä¼˜é€‰æ¸¸æˆ
    calculate_featured_games(games, season_id)
```

### 2.3 æ•°æ®ä¸€è‡´æ€§ä¿éšœ

#### åŸå­æ€§ä¿è¯

```python
@transaction.atomic
def submit_rating(rating_data: RatingSubmitRequest) -> Rating:
    """
    æäº¤è¯„åˆ†(åŸå­æ“ä½œ)
    """
    # 1. éªŒè¯æƒé™
    validate_rating_permission(rating_data.rater_id, rating_data.game_id)

    # 2. æ£€æŸ¥è¯„åˆ†é˜¶æ®µçŠ¶æ€
    check_scoring_phase_active()

    # 3. æ£€æŸ¥é€Ÿç‡é™åˆ¶(10åˆ†é’Ÿå†…â‰¤6ä¸ªè¯„åˆ†)
    check_rate_limit(rating_data.rater_id)

    # 4. ä¿å­˜è¯„åˆ†
    rating = Rating.objects.create(**rating_data.dict())

    # 5. è§¦å‘å¼‚æ­¥é‡ç®—ä»»åŠ¡
    trigger_recalculation_task(rating.game_id)

    return rating
```

#### å¹‚ç­‰æ€§ä¿è¯

```python
def trigger_recalculation_task(game_id: int):
    """
    è§¦å‘é‡ç®—ä»»åŠ¡(å¹‚ç­‰)
    """
    # ä½¿ç”¨Redisé”,é˜²æ­¢é‡å¤è§¦å‘
    lock_key = f"recalc_lock:{game_id}"
    lock = redis_client.lock(lock_key, timeout=300, blocking_timeout=1)

    if lock.acquire():
        try:
            # å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—
            message_queue.publish({
                'action': 'recalculate',
                'game_id': game_id,
                'timestamp': datetime.now().isoformat()
            })
        finally:
            lock.release()
```

#### æ•°æ®æ ¡éªŒ

```python
def validate_data_consistency():
    """
    æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ(å®šæ—¶ä»»åŠ¡)
    """
    issues = []

    # æ ¡éªŒ1: è¯„åˆ†æ€»æ•° vs äººæ¬¡æ€»æ•°
    for dimension in DIMENSIONS:
        ratings_count = Rating.objects.filter(
            dimension=dimension,
            is_valid=True
        ).count()

        total_count = GameDimensionScore.objects.aggregate(
            total=Sum('total_rating_count')
        )['total'] or 0

        if ratings_count != total_count:
            issues.append(f"ç»´åº¦{dimension}: è¯„åˆ†æ€»æ•°({ratings_count}) != äººæ¬¡æ€»æ•°({total_count})")

    # æ ¡éªŒ2: æ¦œå•æ•°æ® vs æ¸¸æˆå¾—åˆ†æ•°æ®
    for dimension in DIMENSIONS:
        for group_type in ['participant', 'judge']:
            ranking = get_latest_ranking(dimension, group_type)
            if not ranking:
                continue

            ranking_games = len(ranking.ranking_data)
            db_games = GameDimensionScore.objects.filter(
                dimension=dimension,
                is_ranked=True
            ).count()

            if ranking_games != db_games:
                issues.append(f"{dimension}-{group_type}: æ¦œå•æ¸¸æˆæ•°({ranking_games}) != DBæ¸¸æˆæ•°({db_games})")

    # å¦‚æœå‘ç°ä¸ä¸€è‡´,å‘é€å‘Šè­¦
    if issues:
        send_alert("æ•°æ®ä¸€è‡´æ€§æ ¡éªŒå¤±è´¥", issues)
```

---

## ä¸‰ã€æ’åè®¡ç®—ç­–ç•¥

### 3.1 è®¡ç®—é¢‘ç‡

#### è¯„åˆ†é˜¶æ®µ(æ’åå‰)

```python
# å¼‚æ­¥è§¦å‘æœºåˆ¶
def on_rating_submitted(rating_id: int):
    """
    æ–°è¯„åˆ†æäº¤åè§¦å‘
    """
    game_id = get_game_id_by_rating(rating_id)

    # å¼‚æ­¥ä»»åŠ¡: ä»…é‡ç®—å—å½±å“çš„æ¸¸æˆå’Œç»´åº¦
    async_recalculate_game.delay(game_id)

    # æ¸…é™¤ç¼“å­˜
    invalidate_ranking_cache(game_id)
```

**ç‰¹ç‚¹**:
- âœ… å®æ—¶å“åº”(5åˆ†é’Ÿå»¶è¿Ÿ)
- âœ… æ€§èƒ½ä¼˜åŒ–(ä»…é‡ç®—ç›¸å…³æ¸¸æˆ)
- âœ… æœ€ç»ˆä¸€è‡´æ€§

#### æ’åå…¬å¸ƒå

```python
# å®šæ—¶ä»»åŠ¡
@app.task
def daily_recalculation():
    """
    æ¯å¤©å‡Œæ™¨2ç‚¹å…¨é‡é‡ç®—
    """
    schedule.every().day.at("02:00").do(job)

    recalculate_all_rankings()
```

**ç‰¹ç‚¹**:
- âœ… æ•°æ®ç¨³å®šæ€§(æ¯æ—¥å…¨é‡)
- âœ… é˜²æ­¢æ•°æ®æ¼‚ç§»
- âœ… æ”¯æŒæ•°æ®ä¿®æ­£

### 3.2 ç¼“å­˜ç­–ç•¥

#### Redisç¼“å­˜è®¾è®¡

```python
# ç¼“å­˜é”®è®¾è®¡
CACHE_KEYS = {
    # æ¸¸æˆå¾—åˆ†(å•ä¸ªæ¸¸æˆ)
    'game_score': 'game:scores:{game_id}',                    # TTL: 5åˆ†é’Ÿ

    # æ¦œå•(12ä¸ªæ¦œå•)
    'ranking': 'ranking:{dimension}:{group_type}:{season_id}', # TTL: 5åˆ†é’Ÿ

    # å…¨å±€å‡å€¼(6ä¸ªç»´åº¦)
    'global_mean': 'global_mean:{dimension}:{season_id}',     # TTL: 1å°æ—¶

    # ç”¨æˆ·è¯„åˆ†çŠ¶æ€(æ˜¯å¦å·²è¯„åˆ†)
    'user_rated': 'user:rated:{user_id}:{game_id}',           # TTL: 1å¤©
}

# ç¼“å­˜æ›´æ–°ç­–ç•¥
def update_ranking_cache(dimension: str, group_type: str, season_id: str):
    """
    æ›´æ–°æ¦œå•ç¼“å­˜
    """
    # 1. ä»æ•°æ®åº“è®¡ç®—æœ€æ–°æ’å
    ranking_data = calculate_ranking(dimension, group_type, season_id)

    # 2. å†™å…¥Redis
    cache_key = CACHE_KEYS['ranking'].format(
        dimension=dimension,
        group_type=group_type,
        season_id=season_id
    )
    redis_client.setex(
        cache_key,
        300,  # TTL: 5åˆ†é’Ÿ
        json.dumps(ranking_data)
    )

    # 3. å‘å¸ƒç¼“å­˜æ›´æ–°é€šçŸ¥(ç”¨äºWebSocketæ¨é€)
    redis_client.publish(f'ranking_updates:{dimension}:{group_type}', json.dumps({
        'action': 'updated',
        'data': ranking_data
    }))
```

#### ç¼“å­˜å¤±æ•ˆç­–ç•¥

```python
# ä¸»åŠ¨å¤±æ•ˆ
def invalidate_game_cache(game_id: int):
    """
    å¤±æ•ˆæ¸¸æˆç›¸å…³ç¼“å­˜
    """
    # å¤±æ•ˆæ¸¸æˆå¾—åˆ†ç¼“å­˜
    redis_client.delete(CACHE_KEYS['game_score'].format(game_id=game_id))

    # å¤±æ•ˆè¯¥æ¸¸æˆæ¶‰åŠçš„6ä¸ªç»´åº¦æ¦œå•
    for dimension in DIMENSIONS:
        for group_type in ['participant', 'judge']:
            redis_client.delete(
                CACHE_KEYS['ranking'].format(
                    dimension=dimension,
                    group_type=group_type,
                    season_id=CURRENT_SEASON
                )
            )

# TTLè‡ªåŠ¨å¤±æ•ˆ
# - æ¸¸æˆå¾—åˆ†ç¼“å­˜: 5åˆ†é’ŸTTL
# - æ¦œå•ç¼“å­˜: 5åˆ†é’ŸTTL
# - å…¨å±€å‡å€¼ç¼“å­˜: 1å°æ—¶TTL(å˜åŒ–è¾ƒå°‘)
```

### 3.3 é‡ç®—æœºåˆ¶

#### è§¦å‘æ¡ä»¶

```python
RECALCULATION_TRIGGERS = {
    'realtime': [
        'on_rating_submitted',          # æ–°è¯„åˆ†æäº¤
        'on_rating_modified',           # è¯„åˆ†ä¿®æ”¹
        'on_cheating_confirmed',        # ç¡®è®¤ä½œå¼Š
        'on_cheating_cleared',          # è¯¯æŠ¥æ¢å¤
    ],
    'scheduled': [
        'daily_2am',                    # æ¯å¤©å‡Œæ™¨2ç‚¹
        'after_cheating_review_batch',  # ä½œå¼Šå¤æ ¸æ‰¹å¤„ç†
    ],
    'manual': [
        'admin_triggered',              # ç®¡ç†å‘˜æ‰‹åŠ¨è§¦å‘
        'algorithm_param_changed',      # ç®—æ³•å‚æ•°è°ƒæ•´
    ],
}
```

#### é‡ç®—ä»»åŠ¡è®¾è®¡

```python
@app.task(bind=True, max_retries=3)
def async_recalculate_game(self, game_id: int):
    """
    å¼‚æ­¥é‡ç®—å•ä¸ªæ¸¸æˆ
    """
    try:
        # 1. è·å–æ¸¸æˆæ‰€æœ‰ç»´åº¦çš„æœ€æ–°å¾—åˆ†
        scores = calculate_all_dimension_scores(game_id)

        # 2. æ›´æ–°æ•°æ®åº“
        update_game_dimension_scores(game_id, scores)

        # 3. æ›´æ–°ç¼“å­˜
        update_game_cache(game_id, scores)

        # 4. è§¦å‘ç›¸å…³æ¦œå•é‡ç®—
        for dimension in scores.keys():
            trigger_ranking_recalculation(dimension)

    except Exception as exc:
        # é‡è¯•æœºåˆ¶(æœ€å¤š3æ¬¡)
        raise self.retry(exc=exc, countdown=60)  # 1åˆ†é’Ÿåé‡è¯•
```

---

## å››ã€ç›‘æ§ä¸å‘Šè­¦

### 4.1 å…³é”®ç›‘æ§æŒ‡æ ‡

#### ä¸šåŠ¡æŒ‡æ ‡

```yaml
# Prometheusç›‘æ§æŒ‡æ ‡
business_metrics:
  - name: scoring_total_count
    type: counter
    description: æ€»è¯„åˆ†æ•°
    labels: [dimension, rater_type]

  - name: scoring_frequency_per_user
    type: gauge
    description: ç”¨æˆ·è¯„åˆ†é¢‘ç‡(10åˆ†é’Ÿçª—å£)
    labels: [user_id]

  - name: ranking_calculation_duration
    type: histogram
    description: æ’åè®¡ç®—è€—æ—¶
    labels: [dimension, group_type]
    buckets: [0.1, 0.5, 1, 2, 5, 10, 30]

  - name: suspicious_rating_count
    type: gauge
    description: å¯ç–‘è¯„åˆ†æ•°é‡
    labels: [detection_type]

  - name: ranked_games_count
    type: gauge
    description: è¿›å…¥æ’åçš„æ¸¸æˆæ•°
    labels: [dimension, group_type]
```

#### æŠ€æœ¯æŒ‡æ ‡

```yaml
technical_metrics:
  - name: api_request_duration
    type: histogram
    description: APIè¯·æ±‚è€—æ—¶
    labels: [endpoint, method]
    buckets: [0.01, 0.05, 0.1, 0.5, 1, 2, 5]

  - name: cache_hit_ratio
    type: gauge
    description: ç¼“å­˜å‘½ä¸­ç‡
    labels: [cache_type]

  - name: database_query_duration
    type: histogram
    description: æ•°æ®åº“æŸ¥è¯¢è€—æ—¶
    labels: [table, operation]
    buckets: [0.001, 0.005, 0.01, 0.05, 0.1, 0.5]

  - name: message_queue_size
    type: gauge
    description: æ¶ˆæ¯é˜Ÿåˆ—ç§¯å‹é‡
    labels: [queue_name]
```

#### æ•°æ®ä¸€è‡´æ€§æŒ‡æ ‡

```yaml
consistency_metrics:
  - name: data_consistency_check_status
    type: gauge
    description: æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ç»“æœ(0=æ­£å¸¸, 1=å¼‚å¸¸)
    labels: [check_type]

  - name: ranking_vs_db_games_mismatch
    type: gauge
    description: æ¦œå•æ¸¸æˆæ•°ä¸DBä¸ä¸€è‡´æ•°é‡
    labels: [dimension, group_type]
```

### 4.2 å‘Šè­¦è§„åˆ™

```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
  - name: scoring_system_alerts
    interval: 30s
    rules:
      # å‘Šè­¦1: å¯ç–‘è¯„åˆ†æ•°é‡å¼‚å¸¸
      - alert: HighSuspiciousRatingCount
        expr: suspicious_rating_count > 50
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "å¯ç–‘è¯„åˆ†æ•°é‡è¿‡å¤š"
          description: "è¿‡å»5åˆ†é’Ÿå†…å‘ç°{{ $value }}ä¸ªå¯ç–‘è¯„åˆ†"

      # å‘Šè­¦2: æ’åè®¡ç®—è€—æ—¶è¿‡é•¿
      - alert: RankingCalculationSlow
        expr: histogram_quantile(0.95, ranking_calculation_duration) > 30
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "æ’åè®¡ç®—è€—æ—¶è¿‡é•¿"
          description: "P95è€—æ—¶è¶…è¿‡30ç§’: {{ $value }}ç§’"

      # å‘Šè­¦3: æ•°æ®ä¸€è‡´æ€§å¼‚å¸¸
      - alert: DataConsistencyCheckFailed
        expr: data_consistency_check_status > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥"
          description: "æ£€æµ‹åˆ°æ•°æ®ä¸ä¸€è‡´,è¯·ç«‹å³æ£€æŸ¥"

      # å‘Šè­¦4: ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½
      - alert: LowCacheHitRatio
        expr: cache_hit_ratio < 0.5
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½"
          description: "ç¼“å­˜å‘½ä¸­ç‡ä»…ä¸º{{ $value }},å»ºè®®æ£€æŸ¥"

      # å‘Šè­¦5: æ¶ˆæ¯é˜Ÿåˆ—ç§¯å‹
      - alert: MessageQueueBacklog
        expr: message_queue_size > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "æ¶ˆæ¯é˜Ÿåˆ—ç§¯å‹"
          description: "é˜Ÿåˆ—{{ $labels.queue_name }}ç§¯å‹{{ $value }}æ¡æ¶ˆæ¯"
```

### 4.3 ç›‘æ§å¤§ç›˜

#### Grafanaé¢æ¿è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è¯„åˆ†ç³»ç»Ÿç›‘æ§å¤§ç›˜                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  [æ ¸å¿ƒæŒ‡æ ‡]                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ ä»Šæ—¥æ€»è¯„åˆ†   â”‚  â”‚ å¯ç–‘è¯„åˆ†æ•°   â”‚  â”‚ æ’åæ¸¸æˆæ•°   â”‚       â”‚
â”‚  â”‚    1,234     â”‚  â”‚     12       â”‚  â”‚    156       â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                              â”‚
â”‚  [æ€§èƒ½æŒ‡æ ‡]                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ æ’åè®¡ç®—è€—æ—¶åˆ†å¸ƒ (P50/P95/P99)                      â”‚     â”‚
â”‚  â”‚ P50: 0.8s  P95: 2.3s  P99: 5.1s                    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                              â”‚
â”‚  [ç¼“å­˜æ€§èƒ½]                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ ç¼“å­˜å‘½ä¸­ç‡è¶‹åŠ¿ (æœ€è¿‘24å°æ—¶)                          â”‚     â”‚
â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  85%       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                              â”‚
â”‚  [æ•°æ®ä¸€è‡´æ€§]                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ è¯„åˆ†æ€»æ•°æ ¡éªŒ â”‚  â”‚ æ¦œå•æ ¡éªŒ     â”‚  â”‚ å…¨å±€å‡å€¼æ ¡éªŒ â”‚       â”‚
â”‚  â”‚   âœ… é€šè¿‡    â”‚  â”‚   âœ… é€šè¿‡    â”‚  â”‚   âœ… é€šè¿‡    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”ã€å›æ»šä¸åº”æ€¥é¢„æ¡ˆ

### 5.1 ç‰¹æ€§å¼€å…³(Feature Flag)

```python
# ç‰¹æ€§å¼€å…³é…ç½®
FEATURE_FLAGS = {
    'scoring_algorithm_v1': {
        'enabled': True,
        'description': 'ç¬¬ä¸€å±Šè¯„åˆ†ç®—æ³•(æˆªå°¾å‡å€¼+è´å¶æ–¯å¹³æ»‘)',
        'config': {
            'trim_percentage': 0.1,       # æˆªå°¾æ¯”ä¾‹10%
            'bayesian_k': 20,             # è´å¶æ–¯kå€¼
            'ranking_threshold': 15,      # æ’åé—¨æ§›
            'judge_weight': 2,            # è¯„å®¡å›¢æƒé‡
        }
    },

    'scoring_algorithm_v2': {
        'enabled': False,
        'description': 'ç¬¬äºŒå±Šè¯„åˆ†ç®—æ³•(å¾…å®š)',
        'config': {
            # æœªæ¥å¯ä»¥å¯ç”¨æ–°ç®—æ³•
        }
    },

    'anti_cheat_strict_mode': {
        'enabled': True,
        'description': 'ä¸¥æ ¼åä½œå¼Šæ¨¡å¼',
    },

    'realtime_recalculation': {
        'enabled': True,
        'description': 'å®æ—¶é‡ç®—(è¯„åˆ†é˜¶æ®µ)',
    },
}

# ä½¿ç”¨ç‰¹æ€§å¼€å…³
def get_algorithm_config():
    """
    è·å–å½“å‰ç®—æ³•é…ç½®
    """
    if FEATURE_FLAGS['scoring_algorithm_v1']['enabled']:
        return FEATURE_FLAGS['scoring_algorithm_v1']['config']
    elif FEATURE_FLAGS['scoring_algorithm_v2']['enabled']:
        return FEATURE_FLAGS['scoring_algorithm_v2']['config']
    else:
        raise Exception("æœªå¯ç”¨ä»»ä½•è¯„åˆ†ç®—æ³•")
```

### 5.2 ç®—æ³•å‚æ•°çƒ­æ›´æ–°

```python
# é…ç½®ç®¡ç†
class AlgorithmConfig:
    """
    ç®—æ³•é…ç½®ç®¡ç†å™¨
    """
    @staticmethod
    def get_config(season_id: str) -> dict:
        """
        ä»æ•°æ®åº“è·å–é…ç½®
        """
        config = AlgorithmConfigModel.objects.get(season_id=season_id)
        return {
            'trim_percentage': config.trim_percentage,
            'bayesian_k': config.bayesian_k,
            'ranking_threshold': config.ranking_threshold,
            'judge_weight': config.judge_weight,
        }

    @staticmethod
    def update_config(season_id: str, new_config: dict, admin_user_id: int):
        """
        æ›´æ–°é…ç½®(éœ€è¦ç®¡ç†å‘˜æƒé™)
        """
        with transaction.atomic():
            # 1. ä¿å­˜æ—§é…ç½®
            old_config = AlgorithmConfig.objects.get(season_id=season_id)

            # 2. æ›´æ–°é…ç½®
            AlgorithmConfig.objects.filter(season_id=season_id).update(**new_config)

            # 3. è®°å½•å®¡è®¡æ—¥å¿—
            AuditLog.objects.create(
                admin_user_id=admin_user_id,
                action='update_algorithm_config',
                old_value=json.dumps(old_config.to_dict()),
                new_value=json.dumps(new_config),
            )

            # 4. è§¦å‘å…¨é‡é‡ç®—
            trigger_full_recalculation(season_id)

            # 5. æ¸…é™¤æ‰€æœ‰ç¼“å­˜
            invalidate_all_caches(season_id)
```

### 5.3 æ•°æ®ä¿®å¤SOP

#### åœºæ™¯1: èµ›åå‘ç°ä½œå¼Šè´¦å·

```python
def handle_cheating_account_after_season(cheater_user_id: int, season_id: str):
    """
    èµ›åå¤„ç†ä½œå¼Šè´¦å·
    """
    # æ­¥éª¤1: æ ‡è®°ä½œå¼Šè´¦å·
    User.objects.filter(id=cheater_user_id).update(
        is_banned=True,
        ban_reason='ä½œå¼Š',
        banned_at=timezone.now()
    )

    # æ­¥éª¤2: ä½œåºŸå…¶è¯„åˆ†
    Rating.objects.filter(
        rater_id=cheater_user_id,
        season_id=season_id
    ).update(
        is_valid=False,
        invalid_reason='ä½œå¼Šè´¦å·ä½œåºŸ'
    )

    # æ­¥éª¤3: é‡ç®—æ’å
    recalculate_all_rankings(season_id)

    # æ­¥éª¤4: é€šçŸ¥å—å½±å“çš„åˆ›ä½œè€…
    affected_creators = get_affected_creators(cheater_user_id)
    for creator in affected_creators:
        send_notification(
            user_id=creator.id,
            title='æ’åå·²è°ƒæ•´',
            message=f'å› ä½œå¼Šè´¦å·å¤„ç†,æ‚¨çš„æ¸¸æˆæ’åå·²è°ƒæ•´',
        )

    # æ­¥éª¤5: å…¬å‘Šæ›´æ–°
    announce_ranking_update(
        reason='å¤„ç†ä½œå¼Šè´¦å·',
        affected_games=len(affected_creators)
    )
```

#### åœºæ™¯2: ç®—æ³•Bugä¿®å¤

```python
def handle_algorithm_bug(fixed_version: str, season_id: str):
    """
    å¤„ç†ç®—æ³•Bugä¿®å¤
    """
    # æ­¥éª¤1: å¤‡ä»½å½“å‰æ¦œå•
    backup_current_rankings(season_id, backup_reason=f'bug_fix_{fixed_version}')

    # æ­¥éª¤2: æ›´æ–°ç®—æ³•ä»£ç (éƒ¨ç½²æ–°ç‰ˆæœ¬)
    # (é€šè¿‡CI/CDæµç¨‹)

    # æ­¥éª¤3: å…¨é‡é‡ç®—
    recalculate_all_rankings(season_id)

    # æ­¥éª¤4: å¯¹æ¯”æ–°æ—§æ¦œå•
    old_rankings = load_backup_rankings(season_id)
    new_rankings = get_current_rankings(season_id)

    changes = compare_rankings(old_rankings, new_rankings)

    # æ­¥éª¤5: å¦‚æœå˜åŒ–è¾ƒå¤§,éœ€è¦å…¬å‘Š
    if changes.significant:
        announce_ranking_update(
            reason='ç®—æ³•ä¿®å¤',
            details=changes.summary
        )
```

#### åœºæ™¯3: æ•°æ®å¼‚å¸¸å›æ»š

```python
def rollback_to_backup(season_id: str, backup_version: int):
    """
    å›æ»šåˆ°å¤‡ä»½ç‰ˆæœ¬
    """
    # æ­¥éª¤1: ç¡®è®¤å›æ»š(éœ€è¦äºŒæ¬¡ç¡®è®¤)
    confirm = input(f"ç¡®è®¤å›æ»šåˆ°å¤‡ä»½ç‰ˆæœ¬{backup_version}? (yes/no): ")
    if confirm != 'yes':
        return

    # æ­¥éª¤2: å¤‡ä»½å½“å‰æ•°æ®(ä»¥é˜²ä¸‡ä¸€)
    backup_current_rankings(season_id, backup_reason='pre_rollback')

    # æ­¥éª¤3: æ¢å¤å¤‡ä»½æ•°æ®
    with transaction.atomic():
        # 3.1 æ¢å¤game_dimension_scoresè¡¨
        restore_table_from_backup(
            table_name='game_dimension_scores',
            backup_version=backup_version
        )

        # 3.2 æ¢å¤rankingsè¡¨
        restore_table_from_backup(
            table_name='rankings',
            backup_version=backup_version
        )

        # 3.3 æ¸…é™¤æ‰€æœ‰ç¼“å­˜
        invalidate_all_caches(season_id)

    # æ­¥éª¤4: è®°å½•å›æ»šæ—¥å¿—
    AuditLog.objects.create(
        action='rollback_rankings',
        details=f'å›æ»šåˆ°å¤‡ä»½ç‰ˆæœ¬{backup_version}',
    )

    # æ­¥éª¤5: é€šçŸ¥ç”¨æˆ·
    send_system_notification(
        title='æ¦œå•å·²å›æ»š',
        message='å› æ•°æ®å¼‚å¸¸,æ¦œå•å·²å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬',
    )
```

### 5.4 åº”æ€¥é¢„æ¡ˆ

#### é¢„æ¡ˆ1: è¯„åˆ†æäº¤æœåŠ¡å¼‚å¸¸

```yaml
incident_type: è¯„åˆ†æäº¤æœåŠ¡å¼‚å¸¸
severity: P0

detection:
  - api_error_rate > 5%
  - api_latency_p99 > 10s

response_steps:
  1. ç«‹å³æ£€æŸ¥æœåŠ¡æ—¥å¿—
  2. å¦‚æœæ˜¯æ•°æ®åº“é—®é¢˜:
     - åˆ‡æ¢åˆ°åªè¯»æ¨¡å¼(æš‚åœè¯„åˆ†æäº¤)
     - æ˜¾ç¤º"è¯„åˆ†æœåŠ¡æš‚æ—¶ä¸å¯ç”¨"æç¤º
  3. å¦‚æœæ˜¯ä»£ç Bug:
     - å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
  4. æ¢å¤å:
     - è¡¥å……ä¸¢å¤±çš„è¯„åˆ†æ•°æ®(å¦‚æœæœ‰)
     - è§¦å‘å…¨é‡é‡ç®—

recovery_time_objective: 15åˆ†é’Ÿå†…æ¢å¤
```

#### é¢„æ¡ˆ2: æ’åè®¡ç®—æœåŠ¡å¼‚å¸¸

```yaml
incident_type: æ’åè®¡ç®—æœåŠ¡å¼‚å¸¸
severity: P1

detection:
  - ranking_calculation_duration_p99 > 60s
  - message_queue_size > 5000

response_steps:
  1. ç«‹å³æ£€æŸ¥è®¡ç®—æœåŠ¡æ—¥å¿—
  2. å¦‚æœæ˜¯æ€§èƒ½é—®é¢˜:
     - æ‰©å®¹è®¡ç®—èŠ‚ç‚¹
     - é™ä½å®æ—¶é‡ç®—é¢‘ç‡(ä»5åˆ†é’Ÿæ”¹ä¸º15åˆ†é’Ÿ)
  3. å¦‚æœæ˜¯æ•°æ®é—®é¢˜:
     - æš‚åœå®æ—¶é‡ç®—
     - æ‰‹åŠ¨ä¿®å¤å¼‚å¸¸æ•°æ®
     - æ¢å¤åå…¨é‡é‡ç®—
  4. æ˜¾ç¤º"æ’åæ•°æ®æ›´æ–°å»¶è¿Ÿ"æç¤º

recovery_time_objective: 30åˆ†é’Ÿå†…æ¢å¤
```

#### é¢„æ¡ˆ3: æ•°æ®ä¸€è‡´æ€§å¼‚å¸¸

```yaml
incident_type: æ•°æ®ä¸€è‡´æ€§å¼‚å¸¸
severity: P0

detection:
  - data_consistency_check_status > 0
  - è¯„åˆ†æ€»æ•° vs äººæ¬¡æ€»æ•°ä¸ä¸€è‡´
  - æ¦œå•æ¸¸æˆæ•° vs DBæ¸¸æˆæ•°ä¸ä¸€è‡´

response_steps:
  1. ç«‹å³æš‚åœæ’åå±•ç¤º(æ˜¾ç¤º"æ•°æ®ç»´æŠ¤ä¸­")
  2. å®šä½ä¸ä¸€è‡´åŸå› 
  3. å¦‚æœæ˜¯è®¡ç®—é€»è¾‘é—®é¢˜:
     - ä¿®å¤Bug
     - å…¨é‡é‡ç®—
  4. å¦‚æœæ˜¯æ•°æ®æŸå:
     - ä»å¤‡ä»½æ¢å¤
     - å…¨é‡é‡ç®—
  5. æ¢å¤åè¿›è¡Œæ•°æ®ä¸€è‡´æ€§éªŒè¯
  6. å…¬å‘Šç”¨æˆ·"æ’åæ•°æ®å·²ä¿®æ­£"

recovery_time_objective: 1å°æ—¶å†…æ¢å¤
```

---

## å…­ã€APIæ¥å£è§„èŒƒ

### 6.1 è¯„åˆ†ç›¸å…³API

#### æäº¤è¯„åˆ†

```http
POST /api/v1/ratings HTTP/1.1
Content-Type: application/json
Authorization: Bearer <token>

{
  "game_id": 123,
  "innovation_score": 8.5,
  "theme_score": 7.0,
  "visual_score": 9.0,
  "audio_score": 8.0,
  "completeness_score": 7.5,
  "fun_factor_score": 8.5
}

# å“åº”
HTTP/1.1 201 Created
{
  "id": 456,
  "game_id": 123,
  "status": "submitted",
  "message": "è¯„åˆ†æäº¤æˆåŠŸ,æ’åå°†åœ¨5åˆ†é’Ÿå†…æ›´æ–°"
}
```

#### ä¿®æ”¹è¯„åˆ†

```http
PUT /api/v1/ratings/{rating_id} HTTP/1.1
Content-Type: application/json
Authorization: Bearer <token>

{
  "innovation_score": 9.0,
  "theme_score": 7.5
}

# å“åº”
HTTP/1.1 200 OK
{
  "id": 456,
  "status": "updated",
  "message": "è¯„åˆ†ä¿®æ”¹æˆåŠŸ,æ’åå°†åœ¨5åˆ†é’Ÿå†…æ›´æ–°"
}
```

### 6.2 æ’åç›¸å…³API

#### è·å–æ¦œå•

```http
GET /api/v1/rankings?dimension=innovation&group=participant&season=season1 HTTP/1.1

# å“åº”
HTTP/1.1 200 OK
{
  "dimension": "innovation",
  "group_type": "participant",
  "season_id": "season1",
  "total_games": 156,
  "rankings": [
    {
      "rank": 1,
      "game_id": 123,
      "game_title": "æ˜Ÿé™…æ¢ç´¢è€…",
      "score": 8.425,
      "rating_count": 50,
      "variance": 0.8
    },
    {
      "rank": 2,
      "game_id": 456,
      "game_title": "åƒç´ å†’é™©",
      "score": 8.425,
      "rating_count": 48,
      "variance": 0.9
    }
  ],
  "last_updated": "2025-01-10T12:00:00Z"
}
```

### 6.3 ç®¡ç†å‘˜API

#### æ‰‹åŠ¨è§¦å‘é‡ç®—

```http
POST /api/v1/admin/rankings/recalculate HTTP/1.1
Content-Type: application/json
Authorization: Bearer <admin_token>

{
  "season_id": "season1",
  "force": true,
  "reason": "ç®—æ³•å‚æ•°è°ƒæ•´åé‡ç®—"
}

# å“åº”
HTTP/1.1 202 Accepted
{
  "task_id": "recalc-task-123",
  "status": "queued",
  "estimated_time": "5-10åˆ†é’Ÿ",
  "message": "é‡ç®—ä»»åŠ¡å·²åŠ å…¥é˜Ÿåˆ—"
}
```

#### æŸ¥çœ‹é‡ç®—çŠ¶æ€

```http
GET /api/v1/admin/rankings/recalculate/status/{task_id} HTTP/1.1

# å“åº”
HTTP/1.1 200 OK
{
  "task_id": "recalc-task-123",
  "status": "processing",
  "progress": {
    "current": 5,
    "total": 12,
    "percentage": 42
  },
  "started_at": "2025-01-10T12:00:00Z",
  "estimated_completion": "2025-01-10T12:08:00Z"
}
```

### 6.4 é”™è¯¯ç è§„èŒƒ

```json
{
  "error_codes": {
    "SCORING_PHASE_ENDED": {
      "code": 4001,
      "message": "è¯„åˆ†é˜¶æ®µå·²ç»“æŸ",
      "http_status": 403
    },
    "ALREADY_RATED": {
      "code": 4002,
      "message": "æ‚¨å·²ç»è¯„ä»·è¿‡è¯¥æ¸¸æˆ",
      "http_status": 409
    },
    "RATE_LIMIT_EXCEEDED": {
      "code": 4003,
      "message": "è¯„åˆ†é¢‘ç‡è¿‡é«˜,è¯·ç¨åå†è¯•",
      "http_status": 429
    },
    "GAME_NOT_FOUND": {
      "code": 4004,
      "message": "æ¸¸æˆä¸å­˜åœ¨",
      "http_status": 404
    },
    "RANKING_NOT_PUBLISHED": {
      "code": 4005,
      "message": "æ’åå°šæœªå…¬å¸ƒ",
      "http_status": 404
    }
  }
}
```

---

## ä¸ƒã€éƒ¨ç½²ä¸è¿ç»´

### 7.1 éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      è´Ÿè½½å‡è¡¡å™¨                           â”‚
â”‚                   (Nginx / ALB)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨æœåŠ¡å™¨é›†ç¾¤                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  App Server â”‚  â”‚  App Server â”‚  â”‚  App Server â”‚     â”‚
â”‚  â”‚     #1      â”‚  â”‚     #2      â”‚  â”‚     #3      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åå°ä»»åŠ¡é›†ç¾¤                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Celery     â”‚  â”‚  Celery     â”‚  â”‚  Celery     â”‚     â”‚
â”‚  â”‚  Worker #1  â”‚  â”‚  Worker #2  â”‚  â”‚  Worker #3  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ PostgreSQL  â”‚  â”‚    Redis    â”‚  â”‚  RabbitMQ   â”‚     â”‚
â”‚  â”‚  (ä¸»ä»å¤åˆ¶)  â”‚  â”‚  (ä¸»ä»å¤åˆ¶)  â”‚  â”‚   (é›†ç¾¤)    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 éƒ¨ç½²æµç¨‹

#### æ ‡å‡†éƒ¨ç½²

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 2. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 3. æ•°æ®åº“è¿ç§»
python manage.py migrate

# 4. æ„å»ºå‰ç«¯èµ„æº
npm run build

# 5. é‡å¯åº”ç”¨æœåŠ¡
systemctl restart jingzhe-ratings-api
systemctl restart jingzhe-ratings-worker

# 6. å¥åº·æ£€æŸ¥
curl http://localhost:8000/health
```

#### æ»šåŠ¨éƒ¨ç½²(é›¶åœæœº)

```bash
# 1. éƒ¨ç½²åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
deploy_to_server server1
wait_for_health_check server1

# 2. éƒ¨ç½²åˆ°ç¬¬äºŒä¸ªèŠ‚ç‚¹
deploy_to_server server2
wait_for_health_check server2

# 3. éƒ¨ç½²åˆ°ç¬¬ä¸‰ä¸ªèŠ‚ç‚¹
deploy_to_server server3
wait_for_health_check server3

# 4. æ¸…ç†æ—§ç‰ˆæœ¬
cleanup_old_versions
```

### 7.3 å®¹é‡è§„åˆ’

#### ç¬¬ä¸€å±Šè§„æ¨¡é¢„ä¼°

```
é¢„æœŸè§„æ¨¡:
- å‚èµ›æ¸¸æˆæ•°: 50-100ä¸ª
- å‚èµ›è€…æ•°: 80-150äºº
- è¯„å®¡å›¢æ•°: 5-10äºº
- æ€»è¯„åˆ†æ•°: 1000-3000æ¡

æ•°æ®é‡ä¼°ç®—:
- è¯„åˆ†æ•°æ®: 3000æ¡ Ã— 6ç»´åº¦ Ã— 100å­—èŠ‚ â‰ˆ 1.8MB
- æ’åæ•°æ®: 12æ¦œå• Ã— 100æ¸¸æˆ Ã— 200å­—èŠ‚ â‰ˆ 240KB
- ç¼“å­˜æ•°æ®: 5åˆ†é’ŸTTL,çº¦10MB

æ•°æ®åº“è§„æ ¼:
- PostgreSQL: 2æ ¸4GB,å­˜å‚¨50GB
- Redis: 1æ ¸2GB,å­˜å‚¨10GB
- åº”ç”¨æœåŠ¡å™¨: 2æ ¸4GB Ã— 3å°
```

#### æ€§èƒ½åŸºå‡†

```
ç›®æ ‡æ€§èƒ½:
- è¯„åˆ†æäº¤API: P95 < 200ms
- æ¦œå•æŸ¥è¯¢API: P95 < 100ms
- æ’åè®¡ç®—: P95 < 10s(å…¨é‡é‡ç®—)
- ç¼“å­˜å‘½ä¸­ç‡: > 80%

å¹¶å‘èƒ½åŠ›:
- è¯„åˆ†æäº¤: 100 QPS
- æ¦œå•æŸ¥è¯¢: 500 QPS
- æ’åé‡ç®—: æ”¯æŒæ¯æ—¥10æ¬¡å…¨é‡é‡ç®—
```

---

## å…«ã€é™„å½•

### 8.1 æŠ€æœ¯æ ˆé€‰å‹

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | ç†ç”± |
|------|---------|------|
| åç«¯æ¡†æ¶ | Django + Django REST Framework | æˆç†Ÿç¨³å®š,ç”Ÿæ€å®Œå–„ |
| æ•°æ®åº“ | PostgreSQL 14+ | æ”¯æŒJSONB,æ€§èƒ½ä¼˜ç§€ |
| ç¼“å­˜ | Redis 6+ | é«˜æ€§èƒ½,æ”¯æŒä¸°å¯Œæ•°æ®ç»“æ„ |
| æ¶ˆæ¯é˜Ÿåˆ— | RabbitMQ / Celery | å¯é çš„ä»»åŠ¡é˜Ÿåˆ— |
| ç›‘æ§ | Prometheus + Grafana | å¼€æºç›‘æ§æ–¹æ¡ˆ |
| æ—¥å¿— | ELK Stack (Elasticsearch + Logstash + Kibana) | æ—¥å¿—èšåˆä¸åˆ†æ |
| éƒ¨ç½² | Docker + Kubernetes | å®¹å™¨åŒ–éƒ¨ç½² |

### 8.2 ç›¸å…³æ–‡æ¡£ç´¢å¼•

- [è¯„åˆ†ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ v2.5](../design/è¯„åˆ†ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ_v1.0.md)
- [æ’åç³»ç»ŸæŠ€æœ¯å®ç°æ–‡æ¡£ v1.0](../design/archive/ranking_system_v1_deprecated/æ’åç³»ç»ŸæŠ€æœ¯å®ç°æ–‡æ¡£_v1.0.md)
- [è¯„åˆ†ç³»ç»Ÿå®ç°ç¼ºå£æ¸…å•](../development/issues/scoring-system-implementation-gaps_2025-01-10.md)
- [å…³é”®åè¯è§£é‡Šç´¢å¼• v1.8](../design/å…³é”®åè¯è§£é‡Šç´¢å¼•_v1.0.md)

### 8.3 ç‰ˆæœ¬å†å²

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ | ä½œè€… |
|------|------|---------|------|
| 2025-01-10 | v1.0 | åˆå§‹ç‰ˆæœ¬,å®Œæˆç³»ç»Ÿæ¶æ„è®¾è®¡ | Claude |

---

**æ–‡æ¡£ç»´æŠ¤è€…**: è€é»‘(Claude)
**çŠ¶æ€**: ğŸ”„ åˆç¨¿
**ä¸‹ä¸€æ­¥**: è¡¥å……APIè®¾è®¡æ–‡æ¡£ã€æ•°æ®åº“è®¾è®¡æ–‡æ¡£ã€è¿ç»´æ‰‹å†Œ
