# 评分系统实现缺口与边界问题清单

> **创建者**: 老黑(Claude)
> **创建时间**: 2025-01-10
> **状态**: 待处理
> **来源**: 基于用户对评分系统设计的全面审阅

---

## 📋 问题总览

| 类别 | 问题数量 | 优先级 |
|------|---------|--------|
| **核心算法决策** | 3个 | P0 |
| **工程实现细节** | 4个 | P0 |
| **边界条件处理** | 3个 | P1 |
| **系统性风险** | 3个 | P1 |
| **总计** | **13个** | - |

---

## 🔴 P0优先级 - 核心算法决策 (3个)

### ✅ 问题1: 单维度得分计算算法已确定

**状态**: 已解决

**最终选择**: 截尾均值(Winsorized Mean, 上下各10%) + 固定k值(k=20)贝叶斯平滑

**文档位置**: [评分系统设计方案 v2.4 §10.2](../docs/design/评分系统设计方案_v1.0.md#L607-L653)

**说明**: 第一届不采用Huber M-估计量,选择简单、解释性强的截尾均值方案。

---

### ✅ 问题2: 并列处理规则已统一

**状态**: 已解决

**最终规则** (v2.3更新):
```
优先级1: 评分人次多的优先 (评审团×2)
优先级2: 方差小的优先
优先级3: 评审团评分占比高的优先
```

**文档位置**: [评分系统设计方案 v2.4 §11.2](../docs/design/评分系统设计方案_v1.0.md#L784-L792)

**说明**: 旧版"评审团得分优先"已更新为"评分人次优先"。

---

### ✅ 问题3: 评审团权重×2应用方式已明确

**状态**: 已解决

**应用场景**(仅两处):
1. **排名资格门槛计算**: `总评分人次 = 参赛者评分人次 + 2 × 评审团评分人次`
2. **并列处理优先级1**: 使用"人次"(评审团×2)而非"人数"

**不用于**: 计算加权平均分(截尾均值时所有评分权重相等)

**文档位置**: [评分系统设计方案 v2.4 §8.1](../docs/design/评分系统设计方案_v1.0.md#L473-L483)

---

## 🔴 P0优先级 - 工程实现细节 (4个)

### ⚠️ 问题4: 排名计算频率与缓存策略未定义

**问题描述**:
当前设计没有明确排名是实时计算还是定时任务批量计算。

**需要决策**:
1. **计算频率**: 实时更新(每次新评分触发) vs 定时任务(每小时/每天)?
2. **缓存策略**: 中间计算结果(截尾均值、贝叶斯平滑分数)是否缓存? TTL多久?
3. **更新触发**: 什么情况下触发重算?仅评分阶段还是排名后也支持?

**建议方案**:
- **评分阶段**: 实时计算 + Redis缓存(TTL 5分钟)
- **排名后**: 定时任务每天凌晨重算一次(防止数据修正)
- **触发时机**: 每次新评分提交后触发异步重算任务

**相关文档**: 需要在**系统架构文档**中补充

---

### ⚠️ 问题5: 数据流水线与ETL流程未定义

**问题描述**:
原始评分数据如何清洗、转换、存储,最终生成12个榜单?这个数据流没有描述。

**需要定义**:
1. **数据流向**: 评分表 → 清洗层 → 计算层 → 榜单表
2. **中间表设计**: 是否需要中间表存储截尾均值、贝叶斯平滑结果?
3. **数据一致性**: 如何保证计算结果与原始评分数据一致?
4. **重算机制**: 算法参数调整后,如何批量重算历史数据?

**建议方案**:
```sql
-- 数据流
ratings_raw (原始评分)
  ↓ [清洗: 排除自评、标记可疑]
ratings_valid (有效评分)
  ↓ [计算: 截尾均值、贝叶斯平滑]
game_scores_XXX (游戏各维度最终得分)
  ↓ [排序、tie-breaker]
rankings_XXX_YYY (12个榜单: 6维度×2群体)
```

**相关文档**: 需要在**系统架构文档**和**数据库设计文档**中补充

---

### ⚠️ 问题6: 监控指标与回滚流程缺失

**问题描述**:
上线后如何监控排名计算的正确性?发现bug如何回滚?

**需要定义**:
1. **监控指标**:
   - 计算耗时(p50/p95/p99)
   - 数据一致性(评分总数 vs 人次总数)
   - 异常检测(分数突变、人次异常)

2. **回滚流程**:
   - 算法参数调整如何热更新?(如截尾比例10%→15%)
   - 发现bug后如何快速回滚到上一版本?
   - 历史榜单是否需要重算并公告?

3. **数据修复SOP**:
   - 赛后发现作弊账号,其评分作废,排名如何重算?
   - 是否提供管理员"重算排名"按钮?
   - 历史榜单更新后是否需要公告用户?

**建议方案**:
- 监控: Prometheus + Grafana,关键指标告警
- 回滚: 特性开关(Feature Flag),支持AB测试
- 修复: 管理后台提供"触发重算"API,记录操作日志

**相关文档**: 需要在**运维手册**中补充

---

### ⚠️ 问题7: API接口规范未定义

**问题描述**:
虽然技术实现文档有函数定义,但缺乏HTTP API规范。

**需要定义**:
1. **排名计算API**:
   - `POST /api/admin/rankings/recalculate` - 手动触发重算
   - `GET /api/admin/rankings/status` - 查看计算状态

2. **评分阶段锁定技术实现**:
   - 前端: 禁用评分按钮
   - 后端: 中间件检查阶段状态,返回403
   - 数据库: 触发器拒绝INSERT

**相关文档**: 需要在**API设计文档**中补充

---

## 🟡 P1优先级 - 边界条件处理 (3个)

### ⚠️ 问题8: 小样本与刚好达标的详细影响未说明

**问题描述**:
21人次的游戏,贝叶斯平滑影响有多大?未达门槛游戏如何参与推荐位分配?

**需要补充**:
1. **贝叶斯平滑影响量化**:
   - 已有: §2.4示例(3人=87%影响, 50人=29%影响)
   - 缺失: 21人、15人的具体影响是多少?

2. **未达门槛游戏推荐位分配**:
   - 当前: §10.2步骤5说"显示原始平均分(供参考)"
   - 缺失: 这些游戏是否参与系统保留的推荐位分配?
   - 建议: 按接近门槛程度排序(14人次 > 13人次 > ...)

**相关文档**: [排名系统技术实现文档 v1.0 §2.4](../docs/design/archive/ranking_system_v1_deprecated/排名系统技术实现文档_v1.0.md#L315-L326)

---

### ⚠️ 问题9: 反作弊监测与排名计算的联动机制缺失

**问题描述**:
可疑评分标记后,如何实时影响排名?复核后如何回溯?

**需要定义**:
1. **可疑评分处理时机**:
   - **选项A(实时)**: 标记后立即从排名计算中剔除
   - **选项B(批处理)**: 每天定时处理过去24小时标记
   - **选项C(人工)**: 仅做标记,等待管理员复核

2. **复核后回溯机制**:
   - 确认作弊: 删除评分,重算排名,历史榜单更新
   - 误报恢复: 恢复评分,重算排名,通知用户

**建议方案**:
- **标记时**: 实时剔除,标记字段`is_suspicious=true`
- **复核确认**:
  - 作弊: `is_valid=false`,触发重算
  - 误报: `is_suspicious=false`,触发重算
- **通知机制**: 受影响的游戏创作者收到通知

**相关文档**: 需要在**反作弊系统设计**中补充

---

### ⚠️ 问题10: 经济系统与排名系统的潜在冲突未评估

**问题描述**:
如果"用金币购买推荐位",可能导致质量一般但金币多的游戏更容易达到15人次门槛。

**需要评估**:
1. **间接影响分析**: 购买曝光 → 更多评分 → 更容易达门槛
2. **是否需要限制**: 推荐位购买是否有上限?
3. **公平性保障**: 系统保留推荐位是否分配给未达门槛游戏?

**建议方案**:
- 第一届: 不出售推荐位,全部系统分配
- 后续: 如果开放购买,设置购买上限(如每游戏每天≤5次)

**相关文档**: 需要在**经济系统设计**中补充风险评估

---

## 🟡 P1优先级 - 系统性风险 (3个)

### ❓ 问题11: "优选游戏"保底机制未定义

**问题描述**:
某届整体水平低,可能出现"0个优选游戏"。是否需要保底机制?

**需要决策**:
- **选项A**: 降低标准(前15而不是前10)
- **选项B**: 设置保底(至少3个优选)
- **选项C**: 接受"无优选游戏"结果

**建议方案**:
- 第一届: 选择**选项C**,接受"无优选游戏"
- 理由: 宁缺毋滥,保持标准一致性
- 沟通: 赛前告知"不一定有优选游戏"

**相关文档**: 需要在[评分系统设计方案 §7.3](../docs/design/评分系统设计方案_v1.0.md#L353-L422)中补充说明

---

### ❓ 问题12: AI使用验证与作弊成本问题

**问题描述**:
当前依赖自主申报+举报仲裁,作弊成本低。是否需要增强验证?

**可选方案**:
1. **提交时验证**:
   - 要求提供工程文件链接(GitHub/GitLab)
   - 要求提供创作过程截图
   - 技术检测: 代码相似度分析

2. **提高惩罚**:
   - 谎报: 永久封禁 + 取消当届参赛资格
   - 通报: 全社区广播作弊行为

**建议方案**:
- 第一届: 保持当前机制(申报+仲裁)
- 后续: 如果问题严重,考虑增加Git链接验证

**相关文档**: 需要在[评分系统设计方案 §6.3](../docs/design/评分系统设计方案_v1.0.md#L282-L300)中补充说明

---

### ⚠️ 问题13: 评分结束后锁定的技术实现未明确

**问题描述**:
"评分阶段结束后锁定"的技术含义模糊,缺乏多层防护设计。

**需要定义**:
1. **前端**:
   - 禁用"开始评分"按钮
   - 显示"评分阶段已结束"提示

2. **后端API**:
   - 中间件检查阶段状态
   - 返回403 Forbidden + 错误码`SCORING_PHASE_ENDED`

3. **数据库层**:
   - 触发器: INSERT前检查`scoring_phase_active`
   - 拒绝写入: 返回错误

**建议方案**: 三层防护全部实施

**相关文档**: 需要在**API设计文档**和**数据库设计文档**中补充

---

## 📊 问题优先级建议

### 第一批(立即处理):
- ✅ 问题1-3: 核心算法决策(已解决,需补充说明)
- ⚠️ 问题4-7: 工程实现细节(系统架构文档)

### 第二批(设计阶段):
- ⚠️ 问题8-10: 边界条件处理(反作弊、经济系统)
- ❓ 问题11-13: 系统性风险(需决策会议讨论)

---

## 🎯 下一步行动

1. **补充系统架构文档**:
   - 排名计算频率与缓存策略
   - 数据流水线与ETL流程
   - 监控指标定义

2. **补充反作弊系统设计**:
   - 可疑评分实时剔除机制
   - 复核后回溯重算流程

3. **补充API设计文档**:
   - 评分阶段锁定技术实现
   - 排名重算API规范

4. **补充运维手册**:
   - 回滚流程
   - 数据修复SOP
   - 应急预案

5. **决策会议**:
   - "优选游戏"保底机制
   - AI使用验证增强措施
   - 推荐位购买限制

---

**创建者**: 老黑(Claude)
**状态**: ⏳ 待处理
**总问题数**: 13个
**预计工作量**: 3-5天(文档编写)
