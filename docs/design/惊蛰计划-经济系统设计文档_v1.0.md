# 惊蛰计划 - 经济系统设计文档

**文档版本**: v1.0
**创建日期**: 2025-01-08
**最后更新**: 2025-01-08
**设计状态**: 🔄 初稿完成，待补充具体数值

---

## 文档说明

本文档定义惊蛰计划的经济系统，包括金币发放、消费、交易、奖励等核心功能。

**系统边界**:
- ✅ 金币管理（发放、消费、余额查询）
- ✅ 打赏交易（评分打赏、游戏打赏）
- ✅ 奖励机制（评分奖励、投票奖励、活跃度奖励）
- ✅ 交易记录（打赏记录、奖励记录、消费记录）

**不包含**:
- ❌ 评分规则 → 见《评分系统设计方案》
- ❌ 排名算法 → 见《排名系统设计文档》
- ❌ 成就解锁 → 见《成就系统设计文档》

---

## 一、核心设计原则

### 1.1 设计目标
> **激励参与、促进互动、形成循环**

### 1.2 核心理念
- **有成本的互动更认真**: 评分必须打赏，形成成本约束
- **净成本为0**: 奖励与打赏平衡，不阻碍参与
- **经济循环**: 金币从评分者流向游戏开发者，激励创作
- **适度激励**: 不过度强调金币，保持比赛的好玩性

---

## 二、金币体系

### 2.1 金币种类

#### 2.1.1 基础金币

| 金币类型 | 获得方式 | 数额 | 状态 |
|---------|---------|------|------|
| 参赛者基础金币 | 提交游戏后获得 | ⏳ 待确认 | 🔄 待设计 |
| 评审团基础金币 | 被标记为评审团时获得 | ⏳ 待确认 | 🔄 待设计 |
| 路人玩家基础金币 | 注册时获得 | ⏳ 待确认 | 🔄 待设计 |
| 注册奖励金币 | 完成注册后获得 | ⏳ 待确认 | 🔄 待设计 |

**待确认问题**:
- [ ] 参赛者基础金币数额？
- [ ] 评审团基础金币数额？
- [ ] 路人玩家基础金币数额？
- [ ] 注册奖励金币数额？

#### 2.1.2 活动金币

| 金币类型 | 获得方式 | 数额 | 状态 |
|---------|---------|------|------|
| 评分奖励金币 | 每次有效评分 | 1金币 | ✅ 已确认 |
| 主题投票奖励金币 | 每日投1/3赞 | 5金币 | ✅ 已确认 |
| 活跃度奖励金币 | 活跃度达标 | ⏳ 待确认 | 🔄 待设计 |
| 赛后结算金币 | 收到的打赏等额 | ⏳ 待确认 | 🔄 待设计 |

**待确认问题**:
- [ ] 活跃度奖励的规则？
- [ ] "赛后获得已收到赏金等额金币"是否适用于所有身份？

---

## 三、金币获取方式

### 3.1 评分奖励

#### 3.1.1 有效评分定义

**定义**: 对某个游戏的第一次评分提交（无论评了几个维度）

**说明**:
- ✅ 第一次提交即可，无论评了几个维度
- ✅ 允许对某些维度给0分
- ❌ 修改和重复不计入
- ❌ 只计算第一次提交

#### 3.1.2 奖励规则

**奖励金额**: 每次有效评分获得1金币

**触发时机**: 评分提交成功后立即到账

**限制**:
- 每个游戏只能获得1次奖励
- 修改评分不再获得奖励
- 评分被删除后回收奖励

**参考决策**: [排名系统决策记录.md - 决策14](./排名系统决策记录.md)

---

### 3.2 主题投票奖励

#### 3.2.1 奖励条件

**条件**: 每日投出总主题量1/3的赞

**说明**:
- 在主题筛选阶段（多轮投票）
- 每天投出的赞数量 ≥ 当天抽取主题总数 ÷ 3
- 每天只能获得1次奖励

#### 3.2.2 奖励规则

**奖励金额**: 5金币

**触发时机**: 每日投票任务完成后立即到账

**目的**: 激励用户参与主题筛选，保证主题质量

**参考**: [内部系统设计文档_v0.3_extended.md 第3.2.1节](./惊蛰计划-内部系统设计文档_v0.3_extended.md#321-基础规则)

---

### 3.3 活跃度奖励（待设计）

#### 3.3.1 活跃度计算

**待确认**:
- [ ] 活跃度如何计算？（登录、浏览、评分、评论、打赏？）
- [ ] 活跃度等级如何划分？
- [ ] 活跃度奖励触发条件？

#### 3.3.2 奖励规则

**待确认**:
- [ ] 活跃度奖励数额？
- [ ] 奖励发放频率？
- [ ] 奖励上限？

---

### 3.4 赛后结算（待设计）

#### 3.4.1 结算规则

**规则**: 赛后获得已收到赏金等额金币

**待确认**:
- [ ] 是否适用于所有身份？（参赛者、评审团、路人玩家？）
- [ ] 结算时间？（评分阶段结束后？结果公布后？）
- [ ] 结算方式？（一次性发放？分批发放？）

#### 3.4.2 金币流向

**赛前**:
- 评分者金币 → 打赏给游戏开发者
- 游戏开发者金币 → 购买推荐位等消费

**赛中**:
- 评分者金币 → 打赏给游戏开发者
- 游戏开发者收到打赏（暂存）

**赛后**:
- 游戏开发者收到的打赏 → 等额金币结算到账户
- 目的: 确保开发者真正获得收益，激励创作

---

## 四、金币消费方式

### 4.1 评分打赏

#### 4.1.1 打赏规则

**强制打赏**: 评分后必须打赏至少1金币

**打赏档位**: 1-10金币（共10档）

**默认档位**: 1金币（减少操作成本）

**限制**:
- 不打赏无法提交评分
- 可以调整打赏金额
- 打赏金额从账户余额扣除

#### 4.1.2 打赏流程

```
1. 用户完成评分
   ↓
2. 系统显示打赏界面（默认1金币）
   ↓
3. 用户调整打赏金额（1-10金币）
   ↓
4. 用户确认提交评分+打赏
   ↓
5. 系统扣除评分者金币
   ↓
6. 系统给游戏开发者增加打赏记录
   ↓
7. 评分提交成功
```

#### 4.1.3 打赏记录

**记录内容**:
- 打赏者ID
- 收到打赏的游戏ID
- 打赏金额
- 打赏时间
- 关联的评分ID

**参考决策**: [排名系统决策记录.md - 决策13](./排名系统决策记录.md)

---

### 4.2 购买推荐位（待设计）

#### 4.2.1 推荐位价格

**待确认**:
- [ ] 购买推荐位的价格是多少金币？
- [ ] 不同推荐位价格是否不同？
- [ ] 高峰时段是否加价？

#### 4.2.2 购买时长

**待确认**:
- [ ] 购买后推荐多久？（24小时？48小时？）
- [ ] 是否可以续费？
- [ ] 是否可以退款？

#### 4.2.3 购买限制

**待确认**:
- [ ] 每个游戏可以购买几次？
- [ ] 是否需要排队？
- [ ] 优先级如何确定？

**参考**: [系统架构总览_v1.0.md - 推荐系统](./惊蛰计划-系统架构总览_v1.0.md#九-推荐系统)

---

### 4.3 其他消费（待设计）

**待设计**:
- [ ] 其他金币消费方式？
- [ ] 特殊功能购买？
- [ ] 虚拟道具购买？

---

## 五、经济模型

### 5.1 金币流向图

```
┌─────────────────────────────────────────────┐
│                  金币循环                     │
└─────────────────────────────────────────────┘

                评分者
                  │
                  │ +1金币 (评分奖励)
                  │
                  ↓
              提交评分
                  │
                  │ -1金币 (评分打赏)
                  │
                  ↓
              游戏开发者
                  │
                  │ 收到打赏 (暂存)
                  │
                  ↓
              赛后结算
                  │
                  │ +等额金币
                  │
                  ↓
              开发者账户
                  │
                  │ 购买推荐位等消费
                  │
                  ↓
              流向其他用户
                  │
                  │ ────────────┐
                  │             │
                  └─────────────┘
                   形成经济循环
```

### 5.2 净成本计算

#### 5.2.1 评分者净成本

**计算公式**:
```
净成本 = 评分打赏 - 评分奖励
      = 1金币 - 1金币
      = 0金币
```

**说明**:
- 评分的净成本为0金币
- 目的: 激励评分但不阻碍参与
- 实际: 评分者需要先有金币才能评分

#### 5.2.2 游戏开发者收益

**计算公式**:
```
收益 = 收到的打赏总和
```

**说明**:
- 开发者收到的打赏暂存
- 赛后结算为等额金币
- 目的: 激励创作，形成经济循环

---

### 5.3 通胀控制（待设计）

**待确认**:
- [ ] 金币总量如何控制？
- [ ] 是否需要回收机制？
- [ ] 是否需要金币上限？
- [ ] 是否需要金币过期机制？

---

## 六、账户管理

### 6.1 余额查询

#### 6.1.1 查询入口

**位置**:
- 个人资料页
- 评分页面
- 打赏页面
- 购买推荐位页面

#### 6.1.2 显示内容

**显示信息**:
- 当前金币余额
- 冻结金币（赛中收到的打赏）
- 可用金币（可以消费的金额）
- 总收入（所有历史收入）
- 总支出（所有历史支出）

---

### 6.2 交易记录

#### 6.2.1 记录类型

**收入记录**:
- 评分奖励 (+1金币)
- 主题投票奖励 (+5金币)
- 活跃度奖励 (+N金币)
- 赛后结算 (+N金币)

**支出记录**:
- 评分打赏 (-1金币)
- 购买推荐位 (-N金币)
- 其他消费 (-N金币)

**暂存记录**:
- 收到的打赏 (+N金币，冻结)
- 赛后结算转出 (-N金币，解冻)

#### 6.2.2 记录详情

**每条记录包含**:
- 交易ID
- 交易类型
- 交易金额
- 交易时间
- 关联对象（游戏ID、用户ID等）
- 交易状态（成功、失败、待处理）

---

### 6.3 金币冻结与解冻

#### 6.3.1 冻结规则

**赛中收到的打赏**:
- 状态: 冻结
- 原因: 赛后结算机制
- 解冻时间: 赛后结算时

#### 6.3.2 解冻规则

**赛后结算**:
- 冻结金币 → 可用金币
- 触发时间: 评分阶段结束后X天（待确认）
- 结算方式: 一次性发放所有冻结金币

---

## 七、数据模型

### 7.1 用户金币表 (user_coins)

| 字段名 | 类型 | 说明 |
|-------|------|------|
| user_id | INT | 用户ID |
| balance | DECIMAL | 可用金币余额 |
| frozen_balance | DECIMAL | 冻结金币余额 |
| total_income | DECIMAL | 总收入 |
| total_expense | DECIMAL | 总支出 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### 7.2 交易记录表 (transactions)

| 字段名 | 类型 | 说明 |
|-------|------|------|
| transaction_id | INT | 交易ID |
| user_id | INT | 用户ID |
| transaction_type | VARCHAR | 交易类型（reward、tip、purchase等） |
| amount | DECIMAL | 交易金额 |
| balance_after | DECIMAL | 交易后余额 |
| related_object_type | VARCHAR | 关联对象类型（game、user等） |
| related_object_id | INT | 关联对象ID |
| status | VARCHAR | 交易状态（success、failed、pending） |
| created_at | DATETIME | 交易时间 |

### 7.3 打赏记录表 (tips)

| 字段名 | 类型 | 说明 |
|-------|------|------|
| tip_id | INT | 打赏ID |
| tipper_id | INT | 打赏者ID |
| receiver_id | INT | 接收者ID |
| game_id | INT | 游戏ID |
| score_id | INT | 评分ID（关联） |
| amount | DECIMAL | 打赏金额 |
| is_frozen | BOOLEAN | 是否冻结（赛中=TRUE） |
| created_at | DATETIME | 打赏时间 |

---

## 八、接口设计

### 8.1 金币相关接口

#### 8.1.1 查询金币余额

```
GET /api/coins/balance
Response:
{
  "balance": 100,
  "frozen_balance": 50,
  "total_income": 500,
  "total_expense": 350
}
```

#### 8.1.2 查询交易记录

```
GET /api/coins/transactions?page=1&limit=20&type=reward
Response:
{
  "total": 100,
  "page": 1,
  "limit": 20,
  "transactions": [
    {
      "transaction_id": 1,
      "type": "reward",
      "amount": 1,
      "created_at": "2025-01-08 12:00:00",
      "related_object": {
        "type": "game",
        "id": 123,
        "name": "游戏名"
      }
    }
  ]
}
```

### 8.2 打赏相关接口

#### 8.2.1 提交评分+打赏

```
POST /api/scores/submit
Request:
{
  "game_id": 123,
  "scores": {
    "innovation": 8.5,
    "theme": 9.0,
    "visual": 7.5,
    "audio": 8.0,
    "completeness": 9.0,
    "fun": 8.5
  },
  "tip_amount": 1
}

Response:
{
  "score_id": 456,
  "tip_id": 789,
  "coins_before": 100,
  "coins_after": 99,
  "message": "评分和打赏提交成功"
}
```

#### 8.2.2 查询打赏记录

```
GET /api/tips/received?game_id=123
Response:
{
  "total_tips": 50,
  "total_amount": 100,
  "tips": [
    {
      "tipper_id": 1,
      "tipper_name": "用户A",
      "amount": 1,
      "created_at": "2025-01-08 12:00:00",
      "is_frozen": true
    }
  ]
}
```

---

## 九、待确认问题清单

### 9.1 基础金币数额

- [ ] 参赛者基础金币数额？
- [ ] 评审团基础金币数额？
- [ ] 路人玩家基础金币数额？
- [ ] 注册奖励金币数额？

### 9.2 奖励机制

- [ ] 活跃度奖励的规则？
  - 活跃度如何计算？
  - 奖励数额多少？
  - 触发条件是什么？
- [ ] "赛后获得已收到赏金等额金币"是否适用于所有身份？
  - 参赛者：✅
  - 评审团：❓
  - 路人玩家：❓

### 9.3 消费机制

- [ ] 购买推荐位的价格是多少金币？
- [ ] 购买后推荐多久？（24小时？48小时？）
- [ ] 是否有其他金币消费方式？

### 9.4 通胀控制

- [ ] 金币总量如何控制？
- [ ] 是否需要回收机制？
- [ ] 是否需要金币上限？
- [ ] 是否需要金币过期机制？

---

## 十、与相关系统的接口

### 10.1 与评分系统的接口

**评分系统 → 经济系统**:
- 评分提交成功后，通知经济系统发放奖励
- 评分打赏扣除金币

**经济系统 → 评分系统**:
- 返回金币余额，判断是否可以评分

### 10.2 与排名系统的接口

**排名系统 → 经济系统**:
- 排名公布后，触发排名奖励（如果有的话）

**经济系统 → 排名系统**:
- 无直接依赖

### 10.3 与成就系统的接口

**经济系统 → 成就系统**:
- 交易记录触发成就解锁（打赏10次、打赏总额100金币等）

**成就系统 → 经济系统**:
- 成就解锁发放金币奖励

---

## 十一、技术实现要点

### 11.1 事务处理

**评分+打赏提交**:
```
BEGIN TRANSACTION
  1. 验证金币余额是否足够
  2. 扣除评分者金币
  3. 创建打赏记录（冻结状态）
  4. 创建评分记录
  5. 发放评分奖励
  6. 记录交易日志
COMMIT
```

**异常处理**:
- 任何步骤失败，回滚整个事务
- 确保金币不会丢失或重复发放

### 11.2 并发控制

**金币余额更新**:
- 使用乐观锁或悲观锁
- 防止并发更新导致余额错误

**打赏记录**:
- 幂等性设计，防止重复提交
- 唯一索引约束

### 11.3 性能优化

**缓存策略**:
- 缓存用户金币余额
- 缓存游戏打赏总额

**异步处理**:
- 交易记录异步写入
- 打赏通知异步发送

---

## 十二、测试要点

### 12.1 功能测试

- ✅ 金币余额查询正确
- ✅ 评分打赏扣除正确
- ✅ 评分奖励发放正确
- ✅ 交易记录完整准确
- ✅ 冻结金币解冻正确

### 12.2 异常测试

- ✅ 金币不足时无法打赏
- ✅ 重复提交不重复扣款
- ✅ 并发更新不丢失金币
- ✅ 事务失败正确回滚

### 12.3 性能测试

- ✅ 高并发打赏性能
- ✅ 大量交易记录查询性能
- ✅ 金币余额更新性能

---

## 版本历史

- **v1.0** (2025-01-08): 初稿完成
  - 定义金币体系（基础金币、活动金币）
  - 定义金币获取方式（评分奖励、投票奖励）
  - 定义金币消费方式（评分打赏、购买推荐位）
  - 定义经济模型（金币流向、净成本计算）
  - 定义数据模型和接口设计
  - 列出待确认问题清单

---

## 相关文档

- [系统架构总览_v1.0.md](./惊蛰计划-系统架构总览_v1.0.md#七-经济系统) - 系统边界和职责
- [评分系统设计方案_v1.0.md](./评分系统设计方案_v1.0.md) - 评分规则（移除了打赏和金币）
- [排名系统决策记录.md](./排名系统决策记录.md) - 决策13、14（评分打赏和奖励）
- [关键名词解释索引_v1.1.md](./关键名词解释索引_v1.1.md#经济系统) - 核心概念定义

---

**创建者**: Claude (老黑)
**审核者**: 蜡烛先生
**下一步**: 补充待确认问题的具体数值
