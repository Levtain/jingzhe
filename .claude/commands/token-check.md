---
description: 检查token使用情况,预估剩余任务需求,提供拆分建议
argument-hint: [--detailed]
allowed-tools: Read, Bash
---

# Token使用量检查器

实时监控token使用情况,评估任务token需求,提供任务拆分和分段式确认建议。

## 核心功能

1. **当前状态检查**
   - 显示已用token百分比
   - 估算剩余可用token
   - 评估当前对话健康度

2. **任务需求预估**
   - 分析剩余任务token需求
   - 识别高风险任务
   - 提供优先级建议

3. **拆分方案建议**
   - 大任务自动拆分
   - 生成阶段式确认清单
   - 优化任务执行顺序

4. **风险预警**
   - Token不足警告
   - 建议保存当前进度
   - 推荐新对话继续

## 使用方法

```bash
/token-check              # 快速检查当前状态
/token-check --detailed   # 详细分析和建议
```

## 执行流程

### 步骤1: 当前状态评估

```markdown
📊 **Token使用状态**

━━━━━━━━━━━━━━━━
当前用量: ████████░░░░░░░░░░░░ 42,856 / 200,000 (21%)
剩余可用: 157,144 tokens
对话健康度: ✅ 良好

━━━━━━━━━━━━━━━━

⏱️ **预估剩余时间**
- 轻度使用: ~4小时
- 正常使用: ~2小时
- 密集使用: ~1小时

💡 **建议**: 当前状态良好,可继续工作
```

### 步骤2: 任务需求分析 (如果提供了任务清单)

```markdown
📋 **剩余任务Token需求分析**

━━━━━━━━━━━━━━━━

🔴 **高风险任务** (超过50K tokens):
1. 文档同步Agent开发 (预计60K tokens)
   → 需要: 拆分为3个阶段

2. 完整的Agent测试 (预计80K tokens)
   → 需要: 拆分为5个阶段

🟡 **中风险任务** (20-50K tokens):
3. 开发3个Command (预计30K tokens)
   → 建议: 分2次对话完成

🟢 **低风险任务** (<20K tokens):
4. 更新文档 (预计10K tokens)
   → 安全: 可在当前对话完成
```

### 步骤3: 拆分方案建议

```markdown
🔧 **推荐执行方案**

━━━━━━━━━━━━━━━━

**方案A: 立即拆分** (推荐)
┌─────────────────────────────────┐
│ 📍 当前对话 (已完成)             │
│ ✅ 开发清单创建                  │
│ ✅ 文件夹结构建立                │
│ ✅ 2个Command开发                │
│ ✅ 部署和测试                    │
│                                  │
│ 用量: 28K tokens (21%)           │
│ 状态: ✅ 健康                    │
└─────────────────────────────────┘
              ↓
🔄 **保存进度并开始新对话**
              ↓
┌─────────────────────────────────┐
│ 📍 新对话#2                      │
│ ⏳ 开发剩余3个Command            │
│    预计: 30K tokens              │
│                                  │
│ ⏳ 开发2个Hook                   │
│    预计: 25K tokens              │
│                                  │
│ 总计: 55K tokens (安全)          │
└─────────────────────────────────┘

**方案B: 当前对话继续** (不推荐)
⚠️ 风险:
- 剩余任务需要80K+ tokens
- 可能超过token上限
- 对话中断风险高

💡 建议: 采用方案A,分2次对话完成
```

### 步骤4: 保存和恢复清单

```markdown
📝 **进度保存和恢复指南**

━━━━━━━━━━━━━━━━

✅ **当前对话已完成**:
1. 开发清单: development/自动化工具开发清单_2025-01-06.md
2. 文件夹结构: development/automation-tools/
3. Command: /discuss, /sync-docs
4. 报告: development/analysis/自动化工具开发完成报告_2025-01-06.md

📌 **下次对话继续时**:

第一步: 恢复上下文
```
读取以下文件了解当前状态:
1. development/自动化工具开发清单_2025-01-06.md
2. development/analysis/自动化工具开发完成报告_2025-01-06.md
3. docs/product/CHANGELOG.md (查看v1.3)

确认: 当前进度=优先级1已完成2个Command
下一步: 继续开发优先级1剩余工具
```

第二步: 继续开发
```
执行任务:
1. 开发/check-progress Command
2. 开发PostToolUse Hook
3. 开发SessionStart Hook
4. 测试所有P1工具
```

━━━━━━━━━━━━━━━━

💾 **建议: 立即保存进度**

执行命令: /save-progress (如果存在)
或手动: 将当前对话标记为"完成"
```

## Token使用规则参考

### 各操作的大致token消耗

```yaml
简单Command开发:
  - 编写: 2-3K tokens
  - 测试: 1K tokens
  - 总计: 3-4K tokens

复杂Command开发:
  - 编写: 5-8K tokens
  - 测试: 2-3K tokens
  - 总计: 7-11K tokens

Hook开发:
  - 编写: 3-5K tokens
  - 测试: 2-4K tokens
  - 总计: 5-9K tokens

Agent开发:
  - 编写: 8-12K tokens
  - 测试: 5-10K tokens
  - 总计: 13-22K tokens

文档更新:
  - 轻度: 1-2K tokens
  - 中度: 3-5K tokens
  - 重度: 6-10K tokens
```

### 安全阈值建议

```yaml
安全操作: <100K tokens (50%)
  - 可执行大部分任务
  - 有足够buffer

谨慎操作: 100-150K tokens (50-75%)
  - 可执行中小任务
  - 大任务需要拆分

警告区域: 150-180K tokens (75-90%)
  - 只执行小任务
  - 建议保存进度

危险区域: >180K tokens (>90%)
  - 只执行紧急小操作
  - 立即开始新对话
```

## 智能建议系统

### 场景1: Token充足 (>50%剩余)

```markdown
✅ **状态: 良好**

当前剩余: 120K tokens (60%)

可执行任务:
- ✅ 开发2-3个Command (安全)
- ✅ 开发1-2个Hook (安全)
- ✅ 更新文档 (安全)
- ⚠️ 开发Agent (建议1个)

建议: 继续当前工作,注意监控
```

### 场景2: Token适中 (30-50%剩余)

```markdown
⚠️ **状态: 注意**

当前剩余: 70K tokens (35%)

建议任务:
- ✅ 开发1-2个Command (谨慎)
- ✅ 更新文档 (安全)
- ⚠️ 开发Hook (建议1个)
- ❌ 开发Agent (不推荐)

建议: 完成当前任务后考虑新对话
```

### 场景3: Token不足 (<30%剩余)

```markdown
🔴 **状态: 警告**

当前剩余: 40K tokens (20%)

强烈建议:
1. ✅ 立即保存当前进度
2. ✅ 生成进度报告
3. ✅ 开始新对话继续工作

可执行:
- ✅ 小型文档更新 (<5K)
- ✅ 快速状态检查
- ❌ 禁止开发新工具
- ❌ 禁止启动Agent
```

### 场景4: Token危险 (<10%剩余)

```markdown
🚨 **状态: 危险**

当前剩余: 15K tokens (7.5%)

立即行动:
1. 🛑 停止所有新任务
2. 💾 保存当前进度
3. 📝 生成恢复清单
4. 🔄 开始新对话

禁止操作:
- ❌ 任何开发任务
- ❌ 文档更新
- ❌ Agent调用

只允许:
- ✅ 保存进度
- ✅ 生成报告
```

## 输出示例

### 示例1: 状态良好

```bash
> /token-check

📊 Token使用状态
━━━━━━━━━━━━━━━━
当前: 42,856 / 200,000 (21%)
剩余: 157,144 tokens
健康度: ✅ 良好

⏱️ 预计剩余时间: 2-4小时

💡 建议: 状态良好,可继续开发剩余3个Command

📋 下一步任务:
1. /check-progress Command (预计4K)
2. PostToolUse Hook (预计6K)
3. SessionStart Hook (预计6K)
总计需求: 16K tokens ✅ 安全
```

### 示例2: 需要拆分

```bash
> /token-check --detailed

📊 Token使用状态
━━━━━━━━━━━━━━━━
当前: 135,000 / 200,000 (67%)
剩余: 65,000 tokens
健康度: ⚠️ 注意

🔴 剩余任务需求:
- 3个Command开发: 30K
- 2个Hook开发: 25K
- 4个Agent开发: 60K
- 文档更新: 10K
总计: 125K tokens ❌ 超出剩余

💡 推荐拆分方案:

📍 当前对话 (保存并结束):
✅ 保存进度到开发清单
✅ 生成完成报告

📍 新对话#1:
⏳ 3个Command + 2个Hook (55K)
   状态: ✅ 可安全完成

📍 新对话#2:
⏳ 2个Agent (30K)
   状态: ✅ 可安全完成

📍 新对话#3:
⏳ 2个Agent (30K)
   状态: ✅ 可安全完成

🔄 建议立即: 保存进度并开始新对话#1
```

## 开发信息

- **创建时间**: 2025-01-06
- **开发者**: 老黑(Claude)
- **版本**: 1.0
- **状态**: 建议立即开发
- **优先级**: 🔴 极高 (应在所有其他任务之前)

## 使用建议

1. **定期检查**: 每完成1-2个任务后检查一次
2. **开发前评估**: 开始大任务前先检查token
3. **预警机制**: 低于30%时立即考虑新对话
4. **进度保存**: 每次对话结束前生成恢复清单

---
