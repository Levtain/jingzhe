---
name: smart-permission-controller
description: PermissionRequest Hook - æ™ºèƒ½æƒé™æ§åˆ¶å™¨,è‡ªåŠ¨æ‰¹å‡†å®‰å…¨çš„å·¥å…·è°ƒç”¨
version: 1.0
trigger: PermissionRequest
---

# PermissionRequest Hook - æ™ºèƒ½æƒé™æ§åˆ¶å™¨

## åŠŸèƒ½è¯´æ˜

è‡ªåŠ¨æ‰¹å‡†å®‰å…¨çš„å·¥å…·è°ƒç”¨,å‡å°‘ç”¨æˆ·æ‰‹åŠ¨ç¡®è®¤æ¬¡æ•°,æå‡å·¥ä½œæ•ˆç‡ã€‚

---

## å·¥ä½œåŸç†

**è§¦å‘æ—¶æœº**: å½“Claude Codeæ˜¾ç¤ºæƒé™ç¡®è®¤å¯¹è¯æ¡†æ—¶

**æ‰§è¡Œæµç¨‹**:
```
Claudeå‡†å¤‡æ‰§è¡Œå·¥å…·è°ƒç”¨
  â†“
æ˜¾ç¤ºæƒé™ç¡®è®¤å¯¹è¯æ¡†
  â†“
PermissionRequest Hookè§¦å‘
  â†“
æ™ºèƒ½åˆ¤æ–­æ“ä½œæ˜¯å¦å®‰å…¨
  â”œâ”€ å®‰å…¨ â†’ è‡ªåŠ¨æ‰¹å‡† (behavior: "allow")
  â”œâ”€ å±é™© â†’ è‡ªåŠ¨æ‹’ç» (behavior: "deny")
  â””â”€ ä¸ç¡®å®š â†’ è¯¢é—®ç”¨æˆ· (ä¸è¿”å›å†³ç­–)
  â†“
æ ¹æ®å†³ç­–ç»§ç»­æˆ–é˜»æ­¢
```

---

## æƒé™æ§åˆ¶ç­–ç•¥

### âœ… è‡ªåŠ¨æ‰¹å‡† (Auto-Allow)

#### 1. åªè¯»æ“ä½œ (100%å®‰å…¨)
- **Read** - è¯»å–æ–‡ä»¶
- **Glob** - æ–‡ä»¶åŒ¹é…
- **Grep** - å†…å®¹æœç´¢
- **WebFetch** - è·å–ç½‘é¡µ
- **WebSearch** - ç½‘ç»œæœç´¢

**ç†ç”±**: åªè¯»æ“ä½œä¸ä¼šä¿®æ”¹ç³»ç»Ÿ,å®Œå…¨å®‰å…¨

#### 2. å®‰å…¨çš„Bashå‘½ä»¤

**æ–‡ä»¶æŸ¥çœ‹**:
```bash
ls            # åˆ—å‡ºæ–‡ä»¶
cat           # æŸ¥çœ‹æ–‡ä»¶
head/tail     # æŸ¥çœ‹æ–‡ä»¶éƒ¨åˆ†
grep          # æœç´¢å†…å®¹
wc -l         # ç»Ÿè®¡è¡Œæ•°
pwd           # æ˜¾ç¤ºå½“å‰ç›®å½•
echo          # è¾“å‡ºæ–‡æœ¬
```

**Gitåªè¯»å‘½ä»¤**:
```bash
git status
git log
git diff
git branch
git show
```

**Pythonå•è¡Œä»£ç **:
```bash
python -c "..."
```

#### 3. é¡¹ç›®æ–‡ä»¶å†™å…¥

**å®‰å…¨çš„å†™å…¥è·¯å¾„**:
- `development/` - å¼€å‘æ–‡ä»¶
- `docs/` - æ–‡æ¡£æ–‡ä»¶
- `.claude/agents/` - Agentå®šä¹‰
- `.claude/commands/` - å‘½ä»¤å®šä¹‰
- `.claude/guide/` - æŒ‡å—æ–‡ä»¶
- `.claude/skills/` - æŠ€èƒ½æ–‡ä»¶
- `.claude/hooks/` - Hookæ–‡ä»¶
- `.claude/templates/` - æ¨¡æ¿æ–‡ä»¶
- `.claude/prompts/` - æç¤ºè¯
- `.claude/workflows/` - å·¥ä½œæµ

**ç†ç”±**: é¡¹ç›®å†…çš„æ–‡ä»¶ä¿®æ”¹æ˜¯æ­£å¸¸å·¥ä½œæµç¨‹

#### 4. Gitæ“ä½œ
```bash
git commit
git push
git pull
git add
```

**ç†ç”±**: ç‰ˆæœ¬æ§åˆ¶æ“ä½œæ˜¯æ—¥å¸¸å·¥ä½œ

#### 5. Taskå·¥å…·
- **Task** - å¯åŠ¨å­agent

**ç†ç”±**: å­agentæ˜¯æ­£å¸¸çš„å·¥ä½œæµç¨‹

---

### âŒ è‡ªåŠ¨æ‹’ç» (Auto-Deny)

#### 1. å±é™©æ–‡ä»¶è·¯å¾„

**ä¿æŠ¤è·¯å¾„** (åŒ…å«ä»¥ä¸‹æ¨¡å¼è‡ªåŠ¨æ‹’ç»):
- `.env` - ç¯å¢ƒå˜é‡(å¯èƒ½åŒ…å«å¯†é’¥)
- `.git/` - Gitç›®å½•(ç‰ˆæœ¬æ§åˆ¶å…ƒæ•°æ®)
- `node_modules/` - ä¾èµ–åŒ…
- `__pycache__/` - Pythonç¼“å­˜
- `.pyc` - Pythonå­—èŠ‚ç 
- `package-lock.json` - é”å®šçš„ä¾èµ–
- `yarn.lock` - Yarné”æ–‡ä»¶
- `.claude/settings` - Hooké…ç½®(ä¿æŠ¤è®¾ç½®)
- `settings.json` - è®¾ç½®æ–‡ä»¶

**ç†ç”±**: è¿™äº›æ–‡ä»¶ä¸åº”è¯¥è¢«AIä¿®æ”¹

#### 2. å±é™©Bashå‘½ä»¤

**ç¦æ­¢çš„å‘½ä»¤æ¨¡å¼**:
```bash
rm -rf           # å¼ºåˆ¶åˆ é™¤
dd               # ç£ç›˜æ“ä½œ
mkfs             # æ ¼å¼åŒ–
chmod 777        # è¿‡åº¦å¼€æ”¾æƒé™
> /dev/          # ç›´æ¥å†™è®¾å¤‡
:(){ :|:& };:    # Forkç‚¸å¼¹
```

**ç†ç”±**: è¿™äº›å‘½ä»¤å¯èƒ½é€ æˆä¸¥é‡ç ´å

---

### â“ è¯¢é—®ç”¨æˆ· (Ask User)

ä»¥ä¸‹æƒ…å†µéœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç¡®è®¤:

#### 1. è·¯å¾„ä¸ç¡®å®šçš„å†™å…¥
- å†™å…¥åˆ°é¡¹ç›®å¤–çš„è·¯å¾„
- å†™å…¥åˆ°æœªçŸ¥ä½ç½®çš„æ–‡ä»¶

#### 2. å¤æ‚çš„Bashå‘½ä»¤
- sed/awkæµç¼–è¾‘
- Pythonè„šæœ¬æ‰§è¡Œ
- å¤šå‘½ä»¤ç®¡é“

#### 3. åŒ…ç®¡ç†æ“ä½œ
- npm install
- pip install
- è™½ç„¶å…è®¸ä½†éœ€è¦å‘ŠçŸ¥ç”¨æˆ·

#### 4. å…¶ä»–æœªæ˜ç¡®çš„æ“ä½œ
- æœªåœ¨ç™½åå•ä¸­çš„å·¥å…·
- ä¸ç†Ÿæ‚‰çš„æ“ä½œç±»å‹

---

## é…ç½®æ–¹æ³•

### æ–¹æ³•1: ç›´æ¥ç¼–è¾‘settings.json

```json
{
  "hooks": {
    "PermissionRequest": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "python d:/Claude/.claude/hooks/permission-request/smart-permission-controller.py"
          }
        ]
      }
    ]
  }
}
```

### æ–¹æ³•2: ä½¿ç”¨/hookså‘½ä»¤

1. è¿è¡Œ `/hooks`
2. é€‰æ‹© `PermissionRequest`
3. æ·»åŠ matcher: `*`
4. æ·»åŠ hookå‘½ä»¤
5. ä¿å­˜

---

## å®‰å…¨åŸåˆ™

### 1. é»˜è®¤å®‰å…¨
- âœ… åªè¯»æ“ä½œé»˜è®¤å…è®¸
- âš ï¸ å†™å…¥æ“ä½œéœ€è¦æ£€æŸ¥
- âŒ å±é™©æ“ä½œé»˜è®¤æ‹’ç»

### 2. ç™½åå•æœºåˆ¶
- é¡¹ç›®è·¯å¾„ç™½åå•
- å®‰å…¨å‘½ä»¤ç™½åå•
- é€æ­¥æ‰©å¤§ç™½åå•èŒƒå›´

### 3. åˆ†å±‚é˜²æŠ¤
- **ç¬¬1å±‚**: å·¥å…·ç±»å‹åˆ¤æ–­
- **ç¬¬2å±‚**: è·¯å¾„å®‰å…¨æ£€æŸ¥
- **ç¬¬3å±‚**: å‘½ä»¤æ¨¡å¼åŒ¹é…
- **ç¬¬4å±‚**: äººå·¥ç¡®è®¤(æœ€åé˜²çº¿)

### 4. é€æ˜å¯å®¡è®¡
```bash
# æ‰€æœ‰å†³ç­–éƒ½ä¼šè®°å½•åˆ°stderr
ğŸ¤– PermissionRequest: Read â†’ allow (åªè¯»æ“ä½œ,å®‰å…¨)
ğŸ¤– PermissionRequest: Write â†’ allow (é¡¹ç›®æ–‡ä»¶,å®‰å…¨)
ğŸ¤– PermissionRequest: Bash â†’ deny (å±é™©å‘½ä»¤è¢«é˜»æ­¢)
```

---

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: è¯»å–æ–‡ä»¶ (è‡ªåŠ¨æ‰¹å‡†)

**å·¥å…·è°ƒç”¨**:
```json
{
  "tool_name": "Read",
  "tool_input": {
    "file_path": "docs/design/xxx.md"
  }
}
```

**Hookå†³ç­–**:
```json
{
  "decision": {
    "behavior": "allow",
    "reason": "Readæ˜¯åªè¯»æ“ä½œ,è‡ªåŠ¨æ‰¹å‡†"
  }
}
```

**ç»“æœ**: âœ… è‡ªåŠ¨æ‰¹å‡†,æ— éœ€ç”¨æˆ·ç¡®è®¤

---

### ç¤ºä¾‹2: å†™å…¥é¡¹ç›®æ–‡ä»¶ (è‡ªåŠ¨æ‰¹å‡†)

**å·¥å…·è°ƒç”¨**:
```json
{
  "tool_name": "Write",
  "tool_input": {
    "file_path": "development/active/issues/questions.md",
    "content": "..."
  }
}
```

**Hookå†³ç­–**:
```json
{
  "decision": {
    "behavior": "allow",
    "reason": "é¡¹ç›®æ–‡ä»¶,å®‰å…¨"
  }
}
```

**ç»“æœ**: âœ… è‡ªåŠ¨æ‰¹å‡†,æ— éœ€ç”¨æˆ·ç¡®è®¤

---

### ç¤ºä¾‹3: å°è¯•ä¿®æ”¹.env (è‡ªåŠ¨æ‹’ç»)

**å·¥å…·è°ƒç”¨**:
```json
{
  "tool_name": "Edit",
  "tool_input": {
    "file_path": ".env",
    "old_string": "...",
    "new_string": "..."
  }
}
```

**Hookå†³ç­–**:
```json
{
  "decision": {
    "behavior": "deny",
    "message": "å±é™©æ“ä½œè¢«é˜»æ­¢: åŒ…å«ä¿æŠ¤è·¯å¾„: .env"
  }
}
```

**ç»“æœ**: âŒ è‡ªåŠ¨æ‹’ç»,ä¿æŠ¤æ•æ„Ÿæ–‡ä»¶

---

### ç¤ºä¾‹4: Gitæ“ä½œ (è‡ªåŠ¨æ‰¹å‡†)

**å·¥å…·è°ƒç”¨**:
```json
{
  "tool_name": "Bash",
  "tool_input": {
    "command": "git status"
  }
}
```

**Hookå†³ç­–**:
```json
{
  "decision": {
    "behavior": "allow",
    "reason": "å®‰å…¨åªè¯»å‘½ä»¤"
  }
}
```

**ç»“æœ**: âœ… è‡ªåŠ¨æ‰¹å‡†

---

### ç¤ºä¾‹5: å±é™©å‘½ä»¤ (è‡ªåŠ¨æ‹’ç»)

**å·¥å…·è°ƒç”¨**:
```json
{
  "tool_name": "Bash",
  "tool_input": {
    "command": "rm -rf node_modules/"
  }
}
```

**Hookå†³ç­–**:
```json
{
  "decision": {
    "behavior": "deny",
    "message": "å±é™©å‘½ä»¤è¢«é˜»æ­¢: \\brm\\s+-rf\\s+"
  }
}
```

**ç»“æœ**: âŒ è‡ªåŠ¨æ‹’ç»

---

### ç¤ºä¾‹6: ä¸ç¡®å®šæ“ä½œ (è¯¢é—®ç”¨æˆ·)

**å·¥å…·è°ƒç”¨**:
```json
{
  "tool_name": "Bash",
  "tool_input": {
    "command": "sed -i 's/foo/bar/g' file.txt"
  }
}
```

**Hookå†³ç­–**:
```python
None  # ä¸è¿”å›å†³ç­–,è®©ç”¨æˆ·ç¡®è®¤
```

**ç»“æœ**: â“ æ˜¾ç¤ºæƒé™å¯¹è¯æ¡†,ç­‰å¾…ç”¨æˆ·ç¡®è®¤

---

## è‡ªå®šä¹‰é…ç½®

### æ·»åŠ å®‰å…¨è·¯å¾„

ç¼–è¾‘ `smart-permission-controller.py`:

```python
def is_safe_file_operation(file_path, tool_name):
    # æ·»åŠ ä½ çš„å®‰å…¨è·¯å¾„
    safe_dirs = [
        'development/',
        'docs/',
        'my-safe-directory/',  # æ–°å¢
    ]

    if any(safe_dir in file_path for safe_dir in safe_dirs):
        return True, "å®‰å…¨ç›®å½•"
```

### æ·»åŠ å®‰å…¨å‘½ä»¤

```python
def is_safe_bash_command(command):
    # æ·»åŠ ä½ çš„å®‰å…¨å‘½ä»¤
    safe_commands = [
        r'^\s*my-safe-command\s+',
    ]

    for pattern in safe_commands:
        if re.match(pattern, command):
            return True, "è‡ªå®šä¹‰å®‰å…¨å‘½ä»¤"
```

### æ·»åŠ å±é™©æ¨¡å¼

```python
def is_safe_bash_command(command):
    # æ·»åŠ ä½ è¦é˜»æ­¢çš„æ¨¡å¼
    dangerous_patterns = [
        r'my-dangerous-pattern',
    ]

    for pattern in dangerous_patterns:
        if re.search(pattern, command):
            return False, f"è‡ªå®šä¹‰å±é™©æ¨¡å¼: {pattern}"
```

---

## æµ‹è¯•æ–¹æ³•

### 1. æµ‹è¯•è‡ªåŠ¨æ‰¹å‡†

```bash
# åº”è¯¥è‡ªåŠ¨æ‰¹å‡†
echo '{"tool_name": "Read", "tool_input": {"file_path": "docs/test.md"}}' | \
  python .claude/hooks/permission-request/smart-permission-controller.py
```

**é¢„æœŸè¾“å‡º**:
```json
{
  "decision": {
    "behavior": "allow",
    "reason": "Readæ˜¯åªè¯»æ“ä½œ,è‡ªåŠ¨æ‰¹å‡†"
  }
}
```

### 2. æµ‹è¯•è‡ªåŠ¨æ‹’ç»

```bash
# åº”è¯¥è‡ªåŠ¨æ‹’ç»
echo '{"tool_name": "Edit", "tool_input": {"file_path": ".env"}}' | \
  python .claude/hooks/permission-request/smart-permission-controller.py
```

**é¢„æœŸè¾“å‡º**:
```json
{
  "decision": {
    "behavior": "deny",
    "message": "å±é™©æ“ä½œè¢«é˜»æ­¢: åŒ…å«ä¿æŠ¤è·¯å¾„: .env"
  }
}
```

### 3. æµ‹è¯•è¯¢é—®ç”¨æˆ·

```bash
# åº”è¯¥è¿”å›None,è®©ç”¨æˆ·ç¡®è®¤
echo '{"tool_name": "Bash", "tool_input": {"command": "sed -i s/foo/bar/g file.txt"}}' | \
  python .claude/hooks/permission-request/smart-permission-controller.py
```

**é¢„æœŸè¾“å‡º**: æ— è¾“å‡º(è®©ç”¨æˆ·ç¡®è®¤)

---

## æ€§èƒ½å½±å“

### æ‰§è¡Œæ—¶é—´
- åªè¯»å·¥å…·: <1ms
- æ–‡ä»¶è·¯å¾„æ£€æŸ¥: <2ms
- Bashå‘½ä»¤æ¨¡å¼åŒ¹é…: <5ms
- **æ€»å¹³å‡**: <10ms

### èµ„æºæ¶ˆè€—
- å†…å­˜: <10MB
- CPU: å¯å¿½ç•¥ä¸è®¡
- ç½‘ç»œ: æ— 

---

## é£é™©è¯„ä¼°

### âœ… å·²ç¼“è§£çš„é£é™©

1. **è¯¯æ‰¹å‡†å±é™©æ“ä½œ**
   - â†’ å¤šå±‚æ£€æŸ¥æœºåˆ¶
   - â†’ ç™½åå•æ¨¡å¼
   - â†’ ä¿å®ˆçš„é»˜è®¤ç­–ç•¥

2. **è¯¯æ‹’ç»æ­£å¸¸æ“ä½œ**
   - â†’ å¯æŸ¥çœ‹stderræ—¥å¿—
   - â†’ å¯è°ƒæ•´è§„åˆ™
   - â†’ æœ€åä»å¯æ‰‹åŠ¨ç¡®è®¤

3. **Hookæ‰§è¡Œå¤±è´¥**
   - â†’ é”™è¯¯ä¸å½±å“æ­£å¸¸æµç¨‹
   - â†’ é™çº§ä¸ºç”¨æˆ·ç¡®è®¤
   - â†’ è®°å½•é”™è¯¯æ—¥å¿—

### âš ï¸ ä»éœ€æ³¨æ„

1. **è§„åˆ™æ›´æ–°**: éšç€é¡¹ç›®å˜åŒ–éœ€è¦æ›´æ–°ç™½åå•
2. **è¯¯æŠ¥ç‡**: å¯èƒ½æœ‰å°‘é‡éœ€è¦æ‰‹åŠ¨ç¡®è®¤çš„æƒ…å†µ
3. **è°ƒè¯•**: åˆæœŸéœ€è¦ä»”ç»†è§‚å¯Ÿå†³ç­–æ˜¯å¦æ­£ç¡®

---

## æ•…éšœæ’é™¤

### é—®é¢˜1: Hookä¸è§¦å‘

**æ£€æŸ¥**:
1. `.claude/settings.json` æ˜¯å¦æ­£ç¡®é…ç½®
2. æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
3. Pythonæ˜¯å¦åœ¨PATHä¸­

**è°ƒè¯•**:
```bash
# ç›´æ¥æµ‹è¯•Hook
python .claude/hooks/permission-request/smart-permission-controller.py < test_input.json
```

### é—®é¢˜2: æ„å¤–æ‹’ç»æ“ä½œ

**æŸ¥çœ‹æ—¥å¿—**:
```bash
# stderrä¼šæ˜¾ç¤ºæ‹’ç»åŸå› 
ğŸ¤– PermissionRequest: Write â†’ deny (åŒ…å«ä¿æŠ¤è·¯å¾„: .env)
```

**è§£å†³**:
1. æ£€æŸ¥æ–‡ä»¶è·¯å¾„æ˜¯å¦åœ¨å±é™©åˆ—è¡¨ä¸­
2. å¦‚æœæ˜¯è¯¯åˆ¤,è°ƒæ•´è§„åˆ™
3. æ·»åŠ è‡ªå®šä¹‰ç™½åå•

### é—®é¢˜3: æ²¡æœ‰è‡ªåŠ¨æ‰¹å‡†é¢„æœŸçš„æ“ä½œ

**å¯èƒ½åŸå› **:
1. è·¯å¾„ä¸åœ¨ç™½åå•ä¸­
2. å‘½ä»¤æ¨¡å¼ä¸åŒ¹é…
3. è§„åˆ™è¿‡äºä¿å®ˆ

**è§£å†³**:
1. æŸ¥çœ‹stderræ—¥å¿—
2. æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´è§„åˆ™
3. æ·»åŠ è‡ªå®šä¹‰å®‰å…¨è·¯å¾„/å‘½ä»¤

---

## ç‰ˆæœ¬å†å²

- **v1.0** (2025-01-12): åˆå§‹ç‰ˆæœ¬
  - åªè¯»æ“ä½œè‡ªåŠ¨æ‰¹å‡†
  - é¡¹ç›®æ–‡ä»¶è‡ªåŠ¨æ‰¹å‡†
  - å±é™©å‘½ä»¤è‡ªåŠ¨æ‹’ç»
  - å¤šå±‚å®‰å…¨æ£€æŸ¥

---

**åˆ›å»ºæ—¶é—´**: 2025-01-12
**ä½œè€…**: Claude & User
**çŠ¶æ€**: âœ… å®ç°å®Œæˆ,å¾…é…ç½®å’Œæµ‹è¯•
