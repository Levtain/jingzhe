# code-review-agent 使用指南

> **Agent名称**: code-review-agent
> **版本**: v1.0
> **创建时间**: 2025-01-10
> **用途**: 自动化代码审核,系统化检查代码质量、安全性、性能和规范性

---

## 🎯 核心功能

code-review-agent 是一个专门用于代码质量审核的Agent,能系统化检查5个维度的代码质量问题,确保代码符合生产标准。

### 主要能力

- 🔒 **安全性检查**: SQL注入、XSS、硬编码密钥等安全漏洞
- ⚡ **性能检查**: O(n²)嵌套循环、N+1查询、缓存缺失等性能问题
- ✅ **正确性检查**: 空指针、异常处理、边界条件等逻辑错误
- 📏 **规范性检查**: 命名规范、代码风格、文档完整性
- 🔧 **可维护性检查**: 代码复杂度、重复代码、设计模式

---

## 🚀 快速开始

### 基本用法

**方式1: 审核当前代码**
```
"审核这段代码"
"代码审核"
"review code"
```

**方式2: 审核特定文件**
```
"审核 src/components/Login.tsx"
"检查这个文件的问题"
```

**方式3: 准备提交前审核**
```
"准备提交代码,先审核一下"
"检查是否可以提交"
```

### 使用场景

```yaml
开发阶段:
  → 功能代码完成
  → "审核这段代码"
  → Agent生成5维审核报告
  → 根据建议修复问题

Git集成:
  → pre-commit hook自动触发
  → 快速审核模式
  → 阻止有严重问题的提交

PR审核:
  → 创建Pull Request
  → "审核这个PR"
  → 深度审核代码
  → 辅助人工审核
```

---

## 📋 审核维度详解

### 维度1: 🔒 安全性检查

**检查内容**:
- SQL注入漏洞
- XSS跨站脚本
- 硬编码密钥/密码
- 缺少权限检查
- 敏感数据泄露

**输出示例**:
```markdown
### 🔒 安全性问题

🔴 **严重** (1个):
- **Line 45**: SQL注入风险
  ```javascript
  const query = `SELECT * FROM users WHERE id = ${userId}`;
  ```
  → 问题: 直接拼接用户输入到SQL查询
  → 风险: 攻击者可执行任意SQL
  → 修复:
  ```javascript
  const query = 'SELECT * FROM users WHERE id = ?';
  db.query(query, [userId]);
  ```

🟡 **中等** (2个):
- Line 78: 硬编码API密钥
- Line 120: 缺少权限检查

🟢 **轻微** (1个):
- Line 203: 敏感信息记录到日志
```

**安全最佳实践**:
- 始终使用参数化查询
- 密钥和密码使用环境变量
- 用户输入必须验证和转义
- 敏感数据不记录到日志

### 维度2: ⚡ 性能检查

**检查内容**:
- O(n²)及以上嵌套循环
- N+1查询问题
- 缺少缓存的热点数据
- 重复的数据库调用
- 低效的算法

**输出示例**:
```markdown
### ⚡ 性能问题

🔴 **严重** (1个):
- **Line 85-95**: O(n²)嵌套循环
  ```python
  for user in users:
    for order in orders:
      if user.id == order.user_id:
        # 处理订单
  ```
  → 问题: 嵌套循环导致O(n*m)复杂度
  → 影响: 1000用户×1000订单 = 100万次迭代
  → 修复: 使用字典或数据库JOIN优化

🟡 **中等** (3个):
- Line 45: N+1查询问题
- Line 120: 缺少缓存
- Line 188: 重复的数据库调用

🟢 **轻微** (2个):
- Line 67: 可提前终止的循环
- Line 234: 字符串拼接可用join优化
```

**性能最佳实践**:
- 避免嵌套循环,使用哈希表
- 使用Eager Loading避免N+1
- 热点数据添加缓存
- 数据库查询使用索引

### 维度3: ✅ 正确性检查

**检查内容**:
- 空指针/未定义引用
- 未捕获的异常
- 除零风险
- 边界条件未处理
- 并发问题

**输出示例**:
```markdown
### ✅ 正确性问题

🔴 **严重** (2个):
- **Line 56**: 空指针风险
  ```javascript
  const userName = user.profile.name;
  ```
  → 问题: user.profile可能为null/undefined
  → 修复: user.profile?.name || 'Unknown'

- **Line 89**: 未捕获的异常
  ```python
  data = json.loads(user_input)
  process(data)
  ```
  → 问题: JSON解析失败会导致程序崩溃
  → 修复: 添加try-except处理

🟡 **中等** (1个):
- Line 145: 边界条件未处理

🟢 **轻微** (2个):
- Line 203: 不可达代码
- Line 278: 未使用的变量
```

**正确性最佳实践**:
- 使用可选链(?.)处理空值
- 始终捕获可能的异常
- 验证输入参数
- 处理边界条件

### 维度4: 📏 规范性检查

**检查内容**:
- 变量命名规范
- 代码风格一致性
- 文档完整性
- 注释质量

**输出示例**:
```markdown
### 📏 规范性问题

🔴 **严重** (0个)

🟡 **中等** (5个):
- Line 23: 变量命名不规范 `temp1` → `userTempData`
- Line 45: 函数名不清晰 `process()` → `processPayment()`
- Line 67-90: 缺少函数文档注释
- Line 89: 缩进不一致(应该是4空格)
- Line 120: 行长度超过120字符

🟢 **轻微** (8个):
- Line 34: 注释风格不统一
- Line 78: 缺少空行分隔
- Line 145: 复杂逻辑无注释
- Line 167, 189, 203, 220: 变量命名可改进
```

**规范性最佳实践**:
- 使用有意义的变量名
- 函数名使用动词开头
- 公共函数必须添加文档
- 统一使用4空格缩进

### 维度5: 🔧 可维护性检查

**检查内容**:
- 函数长度(>50行)
- 圈复杂度(>10)
- 代码重复
- 设计模式使用

**输出示例**:
```markdown
### 🔧 可维护性问题

🔴 **严重** (1个):
- **Line 78-156**: 函数过长(79行)
  → 问题: 函数`processOrder()`有79行,逻辑复杂
  → 影响: 难以理解和维护
  → 修复: 拆分为多个小函数

🟡 **中等** (3个):
- Line 45-60: 重复代码(出现3次)
- Line 120-145: 圈复杂度15(推荐<10)
- Line 188: 紧耦合,依赖具体实现

🟢 **轻微** (2个):
- Line 67: 缺少单元测试
- Line 234: 可提取为公共函数
```

**可维护性最佳实践**:
- 函数不超过50行
- 圈复杂度不超过10
- 提取重复代码为函数
- 使用依赖注入降低耦合

---

## 📊 完整报告示例

```markdown
# 🔍 代码审核报告

**审核时间**: 2025-01-10 23:55
**审核范围**: 5个文件
**代码行数**: 1,234行
**审核人**: code-review-agent

---

## 📊 总体评估

**代码质量评分**: ⭐⭐⭐⭐ (4/5星)

**问题统计**:
- 🔴 严重: 3个
- 🟡 中等: 12个
- 🟢 轻微: 8个
- ✅ 通过: 85项检查

**优点**:
1. 代码结构清晰,模块化良好
2. 错误处理较完善
3. 大部分函数命名规范

**需要改进**:
1. 存在2个SQL注入风险,必须修复
2. 部分函数过长,需要拆分
3. 缺少单元测试

---

[5个维度的详细检查...]

---

## 📝 修改建议优先级

### 🔴 必须修复 (阻塞提交)

1. **SQL注入风险**
   - 位置: src/api/users.js:45
   - 问题: 直接拼接用户输入到SQL查询
   - 修复: 使用参数化查询
   - 预计时间: 5分钟

2. **硬编码API密钥**
   - 位置: src/config.js:78
   - 问题: API密钥硬编码在源代码
   - 修复: 移到环境变量
   - 预计时间: 3分钟

3. **空指针风险**
   - 位置: src/utils/helpers.js:56
   - 问题: 未检查null/undefined
   - 修复: 添加可选链或空值检查
   - 预计时间: 2分钟

**总计**: 3个,预计10分钟

### 🟡 强烈建议 (提升质量)

1. **函数过长**
   - 位置: src/services/order.js:78-156
   - 问题: 函数79行,逻辑复杂
   - 建议: 拆分为5个小函数
   - 预计时间: 20分钟

[更多中等问题...]

**总计**: 12个,预计45分钟

### 🟢 可选优化 (锦上添花)

1. **变量命名改进**
   - 位置: src/components/User.tsx:23
   - 建议: `temp1` → `userTempData`
   - 预计时间: 1分钟

[更多轻微问题...]

**总计**: 8个,预计15分钟

---

## 💡 最佳实践建议

### 安全性
- 始终使用参数化查询或ORM
- 密钥和密码使用环境变量或密钥管理服务
- 用户输入必须验证、转义和清理
- 实施最小权限原则

### 性能
- 避免嵌套循环,使用哈希表查找
- 使用Eager Loading或JOIN避免N+1
- 热点数据添加Redis缓存
- 定期分析慢查询日志

### 代码风格
- 使用有意义的变量和函数名
- 公共API必须添加文档注释
- 函数单一职责,不超过50行
- 统一代码风格,使用Lint工具

---

## 🎯 结论

**审核结果**: ⚠️ 需要修复后提交

**理由**: 发现3个严重安全问题(SQL注入、硬编码密钥、空指针风险),必须修复后才能提交。

**下一步**:
1. ✅ 修复所有🔴严重问题 (预计10分钟)
2. 🟡 考虑修复🟡中等问题 (预计45分钟)
3. 🟢 可选修复🟢轻微问题 (预计15分钟)
4. 修复后重新审核确认

---

**报告生成时间**: 2025-01-10 23:55
**Agent版本**: v1.0
```

---

## 💡 使用技巧

### 技巧1: 三种审核模式

```yaml
快速模式 (Quick):
  用途: Git pre-commit hook
  重点: 仅检查严重问题
  耗时: <30秒

标准模式 (Standard):
  用途: 日常开发
  重点: 所有5个维度
  耗时: 2-5分钟

深度模式 (Deep):
  用途: 重要功能,发布前
  重点: 全面深度分析
  耗时: 10-15分钟
```

### 技巧2: 集成到Git Hook

```bash
# .git/hooks/pre-commit
#!/bin/bash
echo "🔍 Running code review..."

# 快速审核,阻止有严重问题的提交
code-review-agent --mode=quick

# 如果有严重问题,阻止提交
if [ $? -ne 0 ]; then
  echo "❌ Commit blocked: Please fix critical issues first"
  exit 1
fi

echo "✅ Code review passed"
```

### 技巧3: CI/CD集成

```yaml
# .github/workflows/code-review.yml
name: Code Review

on: [pull_request]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run code review
        run: |
          code-review-agent --mode=standard
      - name: Comment PR
        uses: actions/github-script@v6
        with:
          script: |
            const report = fs.readFileSync('review-report.md', 'utf8')
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            })
```

### 技巧4: 团队协作

```yaml
多人项目:
  - 统一代码风格标准
  - 集成到pre-commit hook
  - PR自动审核
  - 审核报告作为Review参考

代码审查:
  - 开发者: 提交前自查
  - Reviewer: 参考审核报告
  - 重点关注: 严重问题
  - 讨论: 中等问题和改进建议
```

---

## ⚠️ 注意事项

### 何时使用

```yaml
✅ 推荐使用:
  - 代码开发完成
  - 准备提交代码
  - 创建Pull Request
  - 发布前检查

❌ 不推荐使用:
  - 代码编写过程中(太频繁)
  - 只想看单个函数(用IDE)
  - 性能分析(用专业工具)
```

### 理解审核结果

```yaml
🔴 严重问题:
  - 必须修复才能提交
  - 安全风险、严重bug
  - 预计修复时间: 短

🟡 中等问题:
  - 强烈建议修复
  - 性能问题、代码质量
  - 预计修复时间: 中

🟢 轻微问题:
  - 可选修复
  - 代码风格、优化建议
  - 预计修复时间: 长
```

---

## 🔄 与其他Agent的配合

### 开发阶段完整流程

```yaml
1. 设计完成
   → design-audit-agent 审核设计

2. 代码开发
   → code-review-agent ← 本Agent
   → 发现问题并修复

3. 完成验证
   → completion-check-agent 验证

4. 提交代码
   → Git Hook 快速审核
```

---

## 📞 常见问题

### Q1: 能完全替代人工审核吗?

**A**: 不能。本Agent是辅助工具:
- ✅ 能发现90%+的常见问题
- ❌ 不能完全替代人工审核
- 💡 建议作为审核的补充,提高效率

### Q2: 误报怎么办?

**A**:
- 静态分析可能有误报
- 使用你的判断
- 如果确认是误报,可以忽略
- 反馈给开发者改进规则

### Q3: 支持哪些编程语言?

**A**:
- **v1.0**: JavaScript/TypeScript, Python, Java
- **v1.1+**: Go, C/C++, Ruby, PHP
- 不支持的语言: 提供通用检查

### Q4: 如何自定义检查规则?

**A**:
- 当前版本不支持自定义
- 未来版本会添加规则配置
- 可以修改Agent源码

### Q5: 审核速度如何?

**A**:
- 快速模式: <30秒
- 标准模式: 2-5分钟(1000行)
- 深度模式: 10-15分钟(1000行)

---

## 🎓 最佳实践

### 实践1: 提交前自查

```yaml
每次提交前:
  1. code-review-agent 快速审核
  2. 修复严重问题
  3. 重新审核确认
  4. 提交代码
```

### 实践2: PR审核流程

```yaml
创建PR:
  1. 开发者创建PR
  2. CI自动运行标准审核
  3. 审核报告评论到PR
  4. Reviewer参考报告审核
  5. 修复问题后更新PR
```

### 实践3: 质量门禁

```yaml
建立质量标准:
  - 严重问题: 0个
  - 中等问题: <5个
  - 代码评分: ≥3星

不达标则:
  - 阻止提交
  - 阻止合并
```

---

## 📈 效果对比

### 使用前

```yaml
问题1: 人工审核耗时
  - 需要逐行检查
  - 容易遗漏问题
  - 不一致的标准

问题2: 问题发现晚
  - 安全问题在生产才发现
  - 性能问题后期才暴露
  - 修复成本高

问题3: 缺少量化标准
  - 主观判断质量
  - 难以追踪改进
```

### 使用后

```yaml
解决1: 自动化审核
  - 2-5分钟全面检查
  - 系统化不遗漏
  - 一致的标准

解决2: 早期发现问题
  - 开发阶段发现
  - 阻止有问题的提交
  - 修复成本低

解决3: 量化评估
  - 代码质量评分
  - 问题优先级
  - 可追踪改进
```

---

## 🔄 版本历史

### v1.0 (2025-01-10)

**新增**:
- 5维代码审核系统
- 三种审核模式
- 具体修复建议
- Git Hook集成

**特点**:
- 自动发现90%+常见问题
- 系统化审核流程
- 清晰的优先级

---

**使用指南创建时间**: 2025-01-10
**维护人**: 老黑(Claude)
**Agent状态**: ✅ 已完成并部署
**版本**: v1.0
