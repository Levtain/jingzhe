# 惊蛰计划 - 推荐位系统设计文档

**文档版本**: v1.1
**创建日期**: 2026-01-11
**最后更新**: 2026-01-11
**设计状态**: ✅ 已完成（P0核心问题已确认）
**相关系统**: 经济系统、评分系统、社区系统

---

## 文档说明

本文档定义惊蛰计划的推荐位系统，包括推荐位分配规则、购买机制、展示策略等核心功能。

**系统边界**:
- ✅ 推荐位分配与购买
- ✅ 危险边缘作品推荐机制
- ✅ 展示时间段管理
- ✅ 评审团推荐特权
- ✅ 赛期/非赛期差异化规则

---

## 一、系统概述

### 1.1 设计目标

> **曝光公平 + 优质激励**

核心原则:
1. **帮助边缘作品**: 优先推荐评分人次不足的游戏
2. **激励优质内容**: 允许购买推荐位，让优秀作品获得更多曝光
3. **评审团特权**: 评审团可推荐优质游戏，帮助玩家发现好作品
4. **时间公平**: 每个游戏每天仅能被推荐一次，避免垄断

### 1.2 推荐位总数

- **总推荐位数**: 12个

---

## 二、推荐位分配策略

### 2.1 赛期规则（互玩互评期）

#### 2.1.1 推荐位分配

| 推荐位类型 | 数量 | 用途 |
|-----------|------|------|
| **系统保留** | 6个 | 危险边缘作品（自动推荐） |
| **可购买** | 6个 | 用户购买推荐 |

**分配逻辑**:
- 在用户购买时段，展示用户购买推荐的游戏
- 在非购买时段，自动展示危险边缘作品

#### 2.1.2 购买权限

| 用户角色 | 是否可购买 | 说明 |
|---------|-----------|------|
| **评审团** | ✅ 可购买 | 每日1次免费额度，最多推荐2款/天 |
| **路人玩家** | ✅ 可购买 | 无免费额度，无次数限制 |
| **参赛者** | ❌ 不可购买 | 一般情况下禁止购买 |

**设计理念**:
- 评审团有推荐特权，帮助发现优质游戏
- 路人玩家可以支持喜欢的游戏
- 参赛者不可购买，避免刷票和恶性竞争

### 2.2 非赛期规则

#### 2.2.1 推荐位分配

| 推荐位类型 | 数量 | 用途 |
|-----------|------|------|
| **全部可购买** | 12个 | 用户购买推荐 |

#### 2.2.2 购买权限

| 用户角色 | 是否可购买 | 说明 |
|---------|-----------|------|
| **所有角色** | ✅ 可购买 | 包括参赛者 |

**展示优先级**: 优秀作品优先展示

---

## 三、危险边缘作品推荐机制

### 3.1 判定标准

**定义**: 总评分人次 < 20 的游戏

**目的**: 帮助评分人次不足的游戏获得更多曝光，避免优秀作品因为未被及时发现而被埋没

### 3.2 推荐逻辑

#### 赛期
- **展示时段**: 非用户购买时段（0:00-7:00, 9:00-12:00, 14:00-18:00）
- **推荐位数**: 6个系统保留位
- **选择策略**: 阶段性随机机制
  - **第1阶段**（评分期前3天）：纯随机选择，所有游戏平等曝光
  - **第2阶段**（评分期3天后）：综合权重排序
    - 评分人次越少，权重越高
    - 提交时间越晚，权重略高（给新游戏机会）
    - 避免同一游戏连续出现（去重机制）
- **评分人次判定**:
  - 0评分人次：算作危险边缘作品
  - 评分人次包含：所有评分者（参赛者+评审团）的评分人次

#### 非赛期
- 危险边缘作品推荐不启用
- 所有推荐位用于展示优秀作品

---

## 四、用户购买推荐机制

### 4.1 购买价格

**价格**: 1000金币/次

### 4.2 展示规则

#### 4.2.1 赛期展示规则

| 项目 | 规则 |
|------|------|
| **单次展示时长** | 30分钟 |
| **推荐频率** | 每个游戏每天仅能被推荐1次 |
| **满位处理** | 推荐位已满时，展示时间向后顺延 |

**展示时间段**（用户购买推荐位）:
- **7:00-9:00**（早间）
- **12:00-14:00**（午间）
- **18:00-24:00**（晚间）

**说明**:
- 其他时间段（0:00-7:00, 9:00-12:00, 14:00-18:00）展示危险边缘作品
- 用户购买推荐集中在流量高峰时段，最大化曝光效果

#### 4.2.2 非赛期展示规则

| 项目 | 规则 |
|------|------|
| **单次展示时长** | 持续1天（从购买时开始，24小时后结束） |
| **推荐频率** | 无限制 |

**说明**: 非赛期主要用于展示优秀作品，推荐时长延长至1天

---

## 五、评审团推荐特权

### 5.1 每日免费额度

| 项目 | 规则 |
|------|------|
| **每日免费推荐** | 1款游戏/天 |
| **每日推荐上限** | 最多2款游戏/天（1个免费+1个付费） |
| **免费次数累积** | 不累积，每日重置 |

### 5.2 推荐展示

**展示标识设计**:
- **卡片上**：
  - 在卡片角落显示"评委推荐"标识
  - 评分期前：显示匿名昵称（如"评委A"、"评委B"）
  - 评分期后：显示评审团真实昵称
  - 不显示头像（避免信息过多）
- **悬浮窗中**：
  - 显示"该游戏被【评审团昵称】推荐"
  - 显示推荐理由（必填，100字限制）
  - 显示推荐时间

**推荐理由规则**:
- **必填项**：评审团必须填写推荐理由
- **字数限制**：100字
- **目的**：
  - 提升推荐质量，避免随意推荐
  - 增加可信度，用户更愿意尝试游戏
  - 体现评审团专业性

**目的**:
- 借助评审团的专业眼光，帮助玩家发现优质游戏
- 增加评审团推荐的可信度和影响力

### 5.3 购买规则

评审团在免费额度用完后，可以付费购买额外推荐：
- **价格**: 1000金币/次
- **每日上限**: 最多2款游戏（含免费）

### 5.4 推荐优先级

**基础规则**：
- 免费推荐与付费推荐按购买时间先后排序（FIFO）
- 体现公平性：付费用户和评审团免费推荐享有同等时间权利

**特殊优化**：
- 同一时间段内（如18:00-18:30这个30分钟时段）：
  - 免费推荐优先展示在更显眼的位置（如推荐位1-3号）
- 保持时间公平性的同时，体现评审团价值

### 5.5 推荐失败处理

**场景**：评审团尝试使用免费推荐但失败时

**处理方式**：
- 弹出提示："今日免费推荐额度已用完，可付费购买（1000金币）"
- 提供明确的付费引导

---

## 六、推荐位队列管理

### 6.1 队列机制

**触发条件**: 当申请推荐时，推荐位已满

**处理方式**: 展示时间向后顺延

**示例**:
```
假设当前有6个购买推荐在队列中：
- 游戏A: 18:00-18:30
- 游戏B: 18:30-19:00
- 游戏C: 19:00-19:30
- 游戏D: 19:30-20:00
- 游戏E: 20:00-20:30
- 游戏F: 20:30-21:00

如果游戏G在18:15申请推荐，则会被排在最后：
- 游戏G: 21:00-21:30
```

### 6.2 队列优先级

**基础规则**: 先到先得（FIFO）

**特殊规则**:
- 同一游戏同一天内多次申请，仅保留最早的一次
- 后续申请提示"该游戏今日已被推荐，是否仍要购买？"
  - 如果确认购买，排在队列后面（同一天只能展示1次）
  - 每个游戏每天仅能被推荐1次，避免垄断

---

## 七、时间段管理

### 7.1 赛期时间段划分

| 时段 | 类型 | 用途 | 推荐位数 |
|------|------|------|---------|
| **0:00-7:00** | 危险边缘 | 自动推荐危险边缘作品 | 6个 |
| **7:00-9:00** | 用户购买 | 展示用户购买推荐 | 6个 |
| **9:00-12:00** | 危险边缘 | 自动推荐危险边缘作品 | 6个 |
| **12:00-14:00** | 用户购买 | 展示用户购买推荐 | 6个 |
| **14:00-18:00** | 危险边缘 | 自动推荐危险边缘作品 | 6个 |
| **18:00-24:00** | 用户购买 | 展示用户购买推荐 | 6个 |

### 7.2 时间段切换逻辑

```
每个时间段结束时：
1. 清空当前展示的用户购买推荐
2. 加载队列中下一批推荐
3. 如果队列为空，展示危险边缘作品
```

---

## 八、购买限制与规则

### 8.1 每日推荐频率限制

**规则**: 每个游戏每天仅能被推荐1次

**目的**:
- 避免同一游戏垄断推荐位
- 给更多游戏获得曝光的机会

**执行**:
- 用户尝试为同一游戏再次推荐时，系统提示"该游戏今日已被推荐"
- 评审团的免费推荐和付费推荐共享此限制

### 8.2 购买次数限制

| 用户角色 | 赛期限制 | 非赛期限制 |
|---------|---------|-----------|
| **评审团** | 最多2款/天（1免费+1付费） | 无限制 |
| **路人玩家** | 无限制 | 无限制 |
| **参赛者** | 不可购买 | 无限制 |

---

## 九、推荐位状态管理

### 9.1 推荐位状态枚举

| 状态代码 | 状态名称 | 说明 |
|---------|---------|------|
| `AVAILABLE` | 可用 | 推荐位空闲，可接受购买 |
| `OCCUPIED` | 占用中 | 正在展示某个游戏 |
| `QUEUED` | 队列中 | 已购买，等待展示 |

### 9.2 状态转换规则

```
AVAILABLE → OCCUPIED (用户购买成功)
OCCUPIED → AVAILABLE (展示时长结束)
AVAILABLE → QUEUED (用户购买时推荐位已满)
QUEUED → OCCUPIED (轮到该游戏展示)
```

---

## 十、数据模型

### 10.1 推荐位表 (recommendation_slots)

| 字段名 | 类型 | 说明 |
|-------|------|------|
| slot_id | INT | 推荐位ID (1-12) |
| slot_type | VARCHAR | 推荐位类型 (purchasable/system) |
| current_game_id | INT | 当前展示的游戏ID |
| status | VARCHAR | 状态 (available/occupied/queued) |
| start_time | DATETIME | 展示开始时间 |
| end_time | DATETIME | 展示结束时间 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### 10.2 推荐记录表 (recommendations)

| 字段名 | 类型 | 说明 |
|-------|------|------|
| recommendation_id | INT | 推荐ID |
| game_id | INT | 被推荐的游戏ID |
| buyer_id | INT | 购买者ID |
| buyer_type | VARCHAR | 购买者类型 (judge/player) |
| slot_id | INT | 推荐位ID |
| is_free | BOOLEAN | 是否为免费推荐 (评审团) |
| price | INT | 购买价格 (0表示免费) |
| start_time | DATETIME | 展示开始时间 |
| end_time | DATETIME | 展示结束时间 |
| status | VARCHAR | 状态 (pending/active/completed) |
| created_at | DATETIME | 创建时间 |

---

## 十一、接口设计

### 11.1 购买推荐位

```
POST /api/recommendations/purchase

Request:
{
  "game_id": 123
}

Response:
{
  "recommendation_id": 456,
  "game_id": 123,
  "start_time": "2025-03-15 18:30:00",
  "end_time": "2025-03-15 19:00:00",
  "price": 1000,
  "coins_before": 1500,
  "coins_after": 500,
  "message": "购买成功，您的游戏将在18:30开始展示"
}

Error Response:
{
  "error": "推荐位已满，您的游戏已加入队列，预计21:00开始展示"
}
```

### 11.2 查询推荐位状态

```
GET /api/recommendations/slots

Response:
{
  "total_slots": 12,
  "available_slots": 4,
  "occupied_slots": 6,
  "queued_count": 2,
  "slots": [
    {
      "slot_id": 1,
      "status": "occupied",
      "game_id": 123,
      "game_name": "游戏名",
      "start_time": "2025-03-15 18:00:00",
      "end_time": "2025-03-15 18:30:00",
      "recommended_by": "评审团-张三"
    },
    ...
  ]
}
```

### 11.3 评审团免费推荐

```
POST /api/recommendations/judge-free

Request:
{
  "game_id": 123
}

Response (成功):
{
  "recommendation_id": 457,
  "game_id": 123,
  "start_time": "2025-03-15 19:00:00",
  "end_time": "2025-03-15 19:30:00",
  "is_free": true,
  "message": "免费推荐成功"
}

Error Response:
{
  "error": "今日免费推荐额度已用完，可付费购买额外推荐"
}
```

---

## 十二、业务逻辑

### 12.1 购买推荐位流程

```
用户点击"购买推荐位"
  ↓
验证用户权限（是否可购买）
  ↓
验证游戏状态（该游戏今日是否已被推荐）
  ↓
检查推荐位是否已满
  ↓
如果未满:
  - 分配推荐位
  - 计算展示时间（当前时段或下一时段）
  - 扣除金币
  - 创建推荐记录
  ↓
如果已满:
  - 加入队列
  - 计算预计展示时间
  - 扣除金币
  - 创建推荐记录（状态=queued）
  ↓
返回购买结果
```

### 12.2 时间段切换流程

```
到达时间段切换点（如7:00, 9:00, 12:00, 14:00, 18:00, 24:00）
  ↓
清空当前用户购买推荐位（6个）
  ↓
检查队列中是否有待展示推荐
  ↓
如果有:
  - 按顺序加载最多6个推荐
  - 更新推荐位状态为occupied
  - 更新推荐记录状态为active
  ↓
如果无:
  - 展示危险边缘作品
  - 随机选择6个评分人次<20的游戏
  ↓
完成切换
```

---

## 十三、前端展示

### 13.1 首页推荐位区域

**布局**: 12个推荐位卡片

**基础卡片信息**:
- 游戏封面图
- 游戏名称
- 游戏赛道（个人/团体）
- 推荐标识：
  - "评委推荐"（卡片角落，显示匿名/真实昵称）
  - "危险区推荐"（系统推荐）

**悬浮窗信息**（鼠标悬浮时）:
- 游戏名称
- 游戏简介（100字符）
- 至多2张游戏截图
- 游戏tag
- 如果是评委推荐：显示推荐理由、推荐时间

### 13.2 购买推荐位按钮

**位置**: 游戏详情页

**按钮文案**: "购买推荐位 (1000金币)"

**点击后**:
- 弹出确认对话框
- 显示预计展示时间
- 确认后扣除金币

**金币不足时**:
- 显示购买按钮（不禁用）
- 点击后提示："金币不足，还差X金币"

**购买后**:
- 不允许取消（第一届简化设计）

### 13.3 推荐位状态展示

**位置**: 后台管理页面

**内容**:
- 当前推荐位使用情况
- 队列中的推荐
- 历史推荐记录

---

## 十四、测试要点

### 14.1 功能测试

- ✅ 购买推荐位成功
- ✅ 推荐位满时正确加入队列
- ✅ 展示时间正确计算
- ✅ 每日推荐频率限制生效
- ✅ 评审团免费推荐额度正确
- ✅ 危险边缘作品正确展示

### 14.2 边界测试

- ✅ 同一游戏同一天内多次购买被拒绝
- ✅ 评审团超过每日上限被拒绝
- ✅ 参赛者在赛期购买被拒绝
- ✅ 金币不足时购买失败

### 14.3 时间段测试

- ✅ 时间段切换时推荐位正确更新
- ✅ 危险边缘作品在非购买时段正确展示
- ✅ 队列中的推荐在正确时间开始展示

---

## 十五、已确认问题清单 ✅ (v1.1更新)

### 15.1 推荐位分配 ✅
- [x] 推荐位总数：12个
- [x] 系统保留：6个（危险边缘作品）
- [x] 可购买：6个

### 15.2 购买价格 ✅
- [x] 价格：1000金币/次

### 15.3 展示规则 ✅
- [x] 赛期单次展示时长：30分钟
- [x] 非赛期单次展示时长：1天
- [x] 每个游戏每天仅能被推荐1次

### 15.4 时间段分配 ✅
- [x] 用户购买时段：7:00-9:00, 12:00-14:00, 18:00-24:00
- [x] 危险边缘时段：0:00-7:00, 9:00-12:00, 14:00-18:00

### 15.5 购买权限 ✅
- [x] 赛期：评审团、路人玩家可购买；参赛者不可购买
- [x] 非赛期：所有角色可购买

### 15.6 评审团特权 ✅
- [x] 每日免费推荐：1款游戏
- [x] 每日推荐上限：2款游戏（1免费+1付费）
- [x] 免费次数不累积，每日重置

### 15.7 危险边缘判定 ✅
- [x] 判定标准：总评分人次 < 20
- [x] 0评分人次算作危险边缘作品
- [x] 评分人次包含所有评分者（参赛者+评审团）
- [x] 阶段性随机机制（前3天纯随机，3天后综合权重）

### 15.8 购买流程 ✅ (新增)
- [x] 购买确认：弹出确认对话框，显示预计展示时间
- [x] 金币不足：显示购买按钮，点击后提示"金币不足，还差X金币"
- [x] 购买后取消：不允许取消（第一届简化）

### 15.9 推荐位卡片展示 ✅ (新增)
- [x] 基础信息：游戏封面图、游戏名称、游戏赛道、推荐标识
- [x] 悬浮窗：游戏名称、简介（100字符）、至多2张截图、游戏tag
- [x] 评委推荐：悬浮窗显示推荐理由、推荐时间

### 15.10 同一游戏多次购买 ✅ (新增)
- [x] 允许购买，提示"该游戏今日已被推荐，是否仍要购买？"
- [x] 确认后排在队列后面

### 15.11 推荐位排序 ✅ (新增)
- [x] 按购买时间先后排序（FIFO）

### 15.12 评审团推荐展示 ✅ (新增)
- [x] 卡片上显示匿名/真实昵称（评分期前/后）
- [x] 不显示头像
- [x] 推荐理由必填，100字限制

### 15.13 评审团推荐优先级 ✅ (新增)
- [x] 基础：按时间排序（FIFO）
- [x] 优化：同一时段内免费推荐优先展示在更显眼位置

### 15.14 评审团推荐失败处理 ✅ (新增)
- [x] 弹出提示："今日免费推荐额度已用完，可付费购买（1000金币）"

---

## 版本历史

- **v1.1** (2026-01-11): P0核心问题确认，更新设计细节
  - ✅ 确认购买流程规则（问题1-3）
  - ✅ 确认推荐位卡片展示设计（问题4）
  - ✅ 确认队列管理规则（问题5-6）
  - ✅ 确认危险边缘作品选择策略（问题7-8）
  - ✅ 确认评审团推荐展示和优先级（问题9-11）
  - 新增：推荐理由必填规则
  - 新增：阶段性随机机制
  - 新增：卡片展示详细设计

- **v1.0** (2026-01-11): 初版完成，基于用户提供的推荐机制描述
  - 定义推荐位分配策略
  - 定义购买规则和权限
  - 定义展示时间段管理
  - 定义评审团特权机制
  - 定义危险边缘作品推荐机制
  - 定义数据模型和接口设计

---

## 相关文档

- [经济系统设计文档 v1.4](./惊蛰计划-经济系统设计文档_v1.0.md) - 金币消费
- [评分系统设计方案 v1.0](./评分系统设计方案_v1.0.md) - 评分人次统计
- [系统架构总览 v1.0](./惊蛰计划-系统架构总览_v1.0.md) - 推荐系统定位

---

**创建者**: Claude (Assistant)
**审核者**: 蜡烛先生
**状态**: ✅ v1.1已完成，P0核心问题已确认
