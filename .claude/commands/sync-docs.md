---
description: 同步所有相关文档,检查一致性,更新版本号和交叉引用
argument-hint: [--check-only | --full]
allowed-tools: Read, Write, Edit, Grep, Bash
---

# 文档同步器

自动检查文档一致性,同步问题答案到设计文档,更新CHANGELOG,同步版本号,更新交叉引用,创建开发日志。

## 功能

1. 检查问题清单和设计文档的一致性
2. 同步已确认问题到设计文档
3. 更新CHANGELOG
4. 同步版本号
5. 更新交叉引用
6. 创建开发日志条目

## 使用方法

```bash
/sync-docs              # 完整同步(默认)
/sync-docs --check-only # 仅检查,不修改
```

## 执行流程

### 步骤1: 检查模式判断

```bash
if $1 == "--check-only":
  仅执行检查,不修改任何文件
else:
  执行完整同步流程
```

### 步骤2: 扫描问题清单文件

```bash
使用Glob查找 development/active/issues/ 目录下的问题清单:
  development/active/issues/*questions.md

对每个问题清单:
1. 读取文件内容
2. 提取已确认问题(标记✅的)
3. 记录问题编号、决策内容、更新日期
```

### 步骤3: 检查设计文档一致性

```bash
对每个已确认问题:
1. 从问题清单提取决策要点
2. 在对应设计文档中查找相关章节
3. 对比内容是否一致
4. 列出不一致的地方

检查项:
- ✅ 决策是否已同步到设计文档
- ✅ 数值/规则是否一致
- ✅ 章节引用是否正确
```

### 步骤4: 生成一致性报告

```markdown
📊 **文档一致性检查报告**

检查时间: 2025-01-06 18:00
检查范围: 3个问题清单, 5个设计文档

━━━━━━━━━━━━━━━━

✅ **一致的文档** (4个):
- 评分系统设计方案_v1.0.md
- 排名系统技术实现文档_v1.0.md
- 用户角色与权限定义.md
- CHANGELOG.md

⚠️ **发现不一致** (1个):
- scoring-system-questions.md vs 评分系统设计方案_v1.0.md
  → Q1.5: 问题清单说"评审团权重×3",设计文档说"×2"

❌ **缺失同步** (2个):
- Q2.1-Q2.3 已确认但未同步到设计文档
- Q1.10 决策已更新但版本号未更新

━━━━━━━━━━━━━━━━

🔧 **需要执行的同步**:
1. 修正评审团权重(×2 vs ×3)
2. 同步Q2.1-Q2.3到排名系统文档
3. 更新版本号为v1.3

准备执行同步...
```

### 步骤5: 执行同步操作

如果不是 --check-only 模式:

```bash
5.1 更新设计文档
    - 根据已确认问题更新相关章节
    - 修正不一致的内容
    - 添加决策日期

5.2 更新CHANGELOG
    - 在顶部添加新版本条目
    - 记录所有变更
    - 格式化变更说明

5.3 同步版本号
    - 检查claude.md版本号
    - 检查设计文档版本号
    - 统一为最新版本

5.4 更新交叉引用
    - 搜索引用旧版本的文档
    - 更新为最新版本号
    - 验证链接有效性

5.5 创建开发日志
    - 文件名: development/logs/dev-log-YYYY-MM-DD.md
    - 记录今日完成的同步
    - 列出修改的文件
    - 记录遇到的问题和解决
```

### 步骤6: 生成同步报告

```markdown
✅ **同步完成报告**

同步时间: 2025-01-06 18:05
执行模式: 完整同步

━━━━━━━━━━━━━━━━

✅ **已更新文档** (5个):
1. 评分系统设计方案_v1.0.md
   - 更新§3.2: 评审团权重 ×2
   - 添加Q2.1-Q2.3决策

2. 排名系统技术实现文档_v1.0.md
   - 同步Q2.1-Q2.3
   - 更新交叉引用

3. CHANGELOG.md
   - 新增v1.3版本条目
   - 记录7项变更

4. claude.md
   - 版本号: v1.2 → v1.3

5. development/logs/dev-log-2025-01-06.md
   - 创建日志条目
   - 记录同步过程

━━━━━━━━━━━━━━━━

🔍 **检查结果**:
- ✅ 所有问题已同步
- ✅ 版本号已统一
- ✅ 交叉引用已更新
- ⚠️ 发现1个可能失效的外部链接

📌 **后续建议**:
1. 检查并修复失效的外部链接
2. 运行 /review-docs 进行质量检查
3. 提交变更到版本控制
```

## 错误处理

### 情况1: 没有问题清单文件

```markdown
⚠️ 警告: 未找到问题清单文件

请确认:
1. development/active/issues/ 目录是否存在
2. 是否有问题清单文件(*questions.md)

建议:
- 如果还没有问题清单,先使用问题分析Agent创建
- 如果在其他位置,手动指定文件路径
```

### 情况2: 没有已确认的问题

```markdown
ℹ️ 提示: 当前没有已确认的问题

无法执行同步,因为:
- 问题清单中没有标记✅的问题
- 还未开始任何讨论

建议:
- 先进行问题讨论
- 确认一些问题后再执行同步
```

### 情况3: 设计文档找不到

```markdown
❌ 错误: 找不到设计文档

问题清单引用的设计文档不存在:
- {文档路径}

请检查:
1. 文档路径是否正确
2. 文档是否已被删除或移动
3. 文档名称是否正确

建议:
- 更新问题清单中的文档引用
- 恢复缺失的设计文档
```

## 同步规则

### 问题清单 → 设计文档

```yaml
规则1: 读取已确认问题的决策
  - 用户选择(A/B/C/D)
  - 用户理由
  - 最终决策内容

规则2: 定位设计文档相关章节
  - 根据问题编号定位章节
  - 根据问题主题搜索相关内容

规则3: 更新设计文档
  - 保留原有结构
  - 更新决策内容
  - 添加决策日期
```

### 版本号同步

```yaml
规则1: CHANGELOG版本号为主
  - 其他文档版本号与CHANGELOG保持一致

规则2: 更新时机
  - 有新的决策确认 → 小版本更新(v1.2 → v1.3)
  - 完成一个模块 → 中版本更新(v1.3 → v2.0)
  - 完成一个阶段 → 大版本更新(v1.0 → v2.0)
```

### 交叉引用更新

```yaml
规则1: 搜索引用模式
  - §章节号
  - [文档名](路径)
  - @文档引用

规则2: 更新引用
  - 章节号变化 → 更新所有引用
  - 文档名变化 → 更新所有引用
  - 版本号变化 → 更新版本引用
```

## 示例

### 输入
```bash
/sync-docs
```

### 输出
(见上面的"同步完成报告"示例)

## 注意事项

1. **备份重要**: 修改前建议备份文档
2. **逐步确认**: 大量同步时建议分批执行
3. **检查模式**: 不确定时先用 --check-only 检查
4. **版本控制**: 同步后及时提交到Git
5. **交叉验证**: 同步后使用 /review-docs 验证

## 开发信息

- **创建时间**: 2025-01-06
- **开发者**: 老黑(Claude)
- **版本**: 1.0
- **状态**: 开发中
- **依赖**: Read, Write, Edit, Grep, Bash工具
